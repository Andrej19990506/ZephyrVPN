# Procurement Planning Module - Design Documentation

## Обзор

Модуль планирования закупок на месяц - это аналитический инструмент для менеджеров, который заменяет ручные таблицы Excel автоматизированным планированием с прогнозированием спроса и рекомендациями по поставщикам.

## Архитектура

### Основные компоненты

1. **ProcurementPlan** - План закупок на месяц
   - Создается автоматически при первом обращении
   - Статусы: `draft`, `submitted`, `approved`, `executed`, `cancelled`

2. **ProcurementPlanItem** - Ячейка матрицы (день × товар)
   - Хранит планируемое количество (вводится менеджером)
   - Содержит прогноз спроса и исторические данные
   - Рекомендации по поставщику и цене

3. **ProcurementHistory** - Исторические данные закупок
   - Строится автоматически из полученных PurchaseOrders
   - Используется для прогнозирования

4. **DemandForecast** - Прогноз спроса
   - Рассчитывается автоматически на основе истории
   - Учитывает день недели, сезонность, тренды

## UI/UX Design

### Основной интерфейс: Интерактивная матрица

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Планирование закупок - Февраль 2026                                    │
│  [Филиал ▼] [◄ Февраль 2026 ►]                    [Отправить план]      │
├─────────────────────────────────────────────────────────────────────────┤
│  Аналитика: Товаров: 45 | Дней: 28 | Высокая загрузка: 8 дней          │
├──────────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬────────────┤
│ Товар    │Всего │ 1 фев│ 2 фев│ 3 фев│ 4 фев│ 5 фев│ ... │ [Аналитика] │
├──────────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼────────────┤
│ Мука     │ 120  │ [10] │ [15] │ [12] │ [10] │ [15] │ ... │            │
│          │  кг  │  Выс │ Сред │  Низ │  Выс │ Сред │     │            │
│          │      │      │      │      │      │      │     │            │
│ Сыр      │  85  │ [ 5] │ [ 8] │ [ 6] │ [ 5] │ [ 8] │ ... │            │
│          │  кг  │  Низ │ Сред │  Низ │  Низ │ Сред │     │            │
│          │      │      │      │      │      │      │     │            │
│ ...      │ ...  │ ...  │ ...  │ ...  │ ...  │ ...  │ ... │            │
└──────────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴────────────┘
```

### Особенности интерфейса:

1. **Фиксированная первая колонка** (sticky) - товары всегда видны при горизонтальной прокрутке
2. **Интерактивные ячейки** - клик по ячейке открывает панель аналитики
3. **Цветовые индикаторы** - прогнозируемая загрузка кухни (высокая/средняя/низкая)
4. **Автосохранение** - изменения сохраняются автоматически при вводе
5. **Панель аналитики** (справа) - показывает детальную информацию при выборе ячейки

### Панель аналитики (при выборе ячейки):

```
┌─────────────────────────────────┐
│ Аналитика                    [X] │
├─────────────────────────────────┤
│ Мука пшеничная                  │
│ Дата: 15.02.2026                │
│                                 │
│ Исторические данные:            │
│ • В прошлом месяце: 12.5 кг     │
│ • Среднее за 3 месяца: 11.2 кг  │
│                                 │
│ Прогноз:                        │
│ • Прогнозируемое: 13.0 кг       │
│ • Уверенность: 75%              │
│ • Загрузка кухни: [Высокая]     │
│                                 │
│ Рекомендация по поставщику:    │
│ • Поставщик: ООО "Хлебопродукт"│
│ • Цена: 45₽/кг                  │
│ • Последний заказ: 10.01.2026   │
└─────────────────────────────────┘
```

## API Endpoints

### 1. GET /api/v1/procurement/monthly-plan

**Параметры запроса:**
- `branch_id` (обязательный) - ID филиала
- `year` (опциональный) - Год (по умолчанию текущий)
- `month` (опциональный) - Месяц 1-12 (по умолчанию текущий)

**Ответ:**
```json
{
  "plan": {
    "id": "uuid",
    "plan_number": "PLAN-2026-02",
    "branch_id": "uuid",
    "month": "2026-02-01",
    "year": 2026,
    "month_number": 2,
    "status": "draft",
    "created_by": "manager_username"
  },
  "matrix": [
    {
      "nomenclature_id": "uuid",
      "nomenclature_name": "Мука пшеничная",
      "sku": "FLOUR-001",
      "unit": "kg",
      "category_name": "Сырье",
      "total_planned": 120.5,
      "suggested_supplier": {
        "supplier_id": "uuid",
        "supplier_name": "ООО Хлебопродукт",
        "price_per_unit": 45.0,
        "last_order_date": "2026-01-10",
        "reliability_score": 85.0
      },
      "cells": [
        {
          "date": "2026-02-01",
          "planned_quantity": 10.0,
          "forecasted_quantity": 12.5,
          "forecast_confidence": 75.0,
          "predicted_kitchen_load": "high",
          "last_month_quantity": 11.0,
          "avg_last_3_months": 10.8,
          "has_data": true
        },
        // ... остальные даты месяца
      ]
    }
    // ... остальные товары
  ],
  "dates": ["2026-02-01", "2026-02-02", ..., "2026-02-28"],
  "analytics": {
    "total_items": 45,
    "total_days": 28,
    "total_planned_value": 125000.0,
    "high_load_days": 8,
    "medium_load_days": 12,
    "low_load_days": 8
  }
}
```

### 2. PUT /api/v1/procurement/plan-cell

**Тело запроса:**
```json
{
  "plan_id": "uuid",
  "nomenclature_id": "uuid",
  "date": "2026-02-15",
  "quantity": 12.5
}
```

**Ответ:**
```json
{
  "success": true
}
```

### 3. POST /api/v1/procurement/submit-plan

**Тело запроса:**
```json
{
  "plan_id": "uuid",
  "created_by": "manager_username"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "План отправлен. Заказы на закупку созданы."
}
```

## Backend Services

### ProcurementPlanningService

**Основные методы:**
- `GetMonthlyPlan(branchID, year, month)` - Получение плана с матрицей
- `UpdatePlanCell(planID, nomenclatureID, date, quantity)` - Обновление ячейки
- `SubmitPlan(planID, createdBy)` - Отправка плана и создание PurchaseOrders

**Логика SubmitPlan:**
1. Группирует позиции плана по дате и поставщику
2. Для каждой комбинации (дата × поставщик) создает PurchaseOrder
3. Объединяет позиции одного товара от одного поставщика в один заказ
4. Обновляет статус плана на `submitted`

### DemandForecastService

**Основные методы:**
- `GetForecast(branchID, nomenclatureID, date)` - Получение прогноза
- `GetHistoricalData(branchID, nomenclatureID, date)` - Исторические данные
- `BuildProcurementHistory(purchaseOrder)` - Построение истории из заказов

**Метод прогнозирования:**
- Использует скользящее среднее за последние 3 месяца
- Учитывает день недели (анализ по дням недели)
- Применяет сезонные коэффициенты
- Рассчитывает уверенность прогноза на основе количества исторических данных

**Алгоритм прогнозирования:**
```
1. Загружаем историю за последние 3 месяца для этого дня недели
2. Если данных < 3: простое среднее, уверенность 30%
3. Если данных >= 3: скользящее среднее, уверенность 70%
4. Применяем сезонный коэффициент (зима +10%, лето -10%)
5. Определяем загрузку кухни:
   - > 100 единиц = high
   - 50-100 = medium
   - < 50 = low
```

## Прогнозирование спроса (Demand Forecasting)

### Подход к прогнозированию

**1. Анализ по дням недели:**
- Система анализирует исторические заказы по дням недели
- Понедельник сравнивается с понедельниками прошлых месяцев
- Учитывается неделя месяца (1-я, 2-я, 3-я, 4-я, 5-я)

**2. Скользящее среднее:**
- Используется среднее значение за последние 3 месяца
- Взвешивание: более свежие данные имеют больший вес
- Формула: `forecast = (sum of last 12 orders) / 12`

**3. Сезонные коэффициенты:**
```go
Зима (12, 1, 2): +10% (выше спрос)
Весна (3, 4, 5): 0% (базовый)
Лето (6, 7, 8): -10% (ниже спрос)
Осень (9, 10, 11): +5% (небольшой рост)
```

**4. Определение загрузки кухни:**
- На основе прогнозируемого количества ингредиентов
- Учитывается сложность блюд (через Recipe/BOM)
- Интеграция с Kitchen Capacity Timeline

### Улучшения в будущем:

1. **Machine Learning модель:**
   - Обучение на исторических данных продаж
   - Учет внешних факторов (праздники, погода, события)
   - Автоматическая корректировка коэффициентов

2. **Интеграция с продажами:**
   - Анализ фактических продаж vs прогноз
   - Корректировка прогнозов на основе отклонений
   - Учет трендов (растущий/падающий спрос)

3. **Мультифакторный анализ:**
   - День недели
   - Неделя месяца
   - Сезонность
   - Праздники
   - Погода
   - Маркетинговые акции

## Интеграция с существующими модулями

### 1. Purchase Orders Module

**Связь:**
- При отправке плана автоматически создаются PurchaseOrders
- Группировка по дате и поставщику
- Связь через `ProcurementPlan.SubmittedAt`

**Процесс:**
```
План → SubmitPlan() → Группировка по (дата, поставщик) → PurchaseOrders
```

### 2. Inventory Module

**Связь:**
- Использует Nomenclature для списка товаров
- Учитывает единицы измерения (InboundUnit)
- Рекомендации по поставщикам на основе истории закупок

### 3. Stock Service

**Связь:**
- При получении PurchaseOrder автоматически обновляется ProcurementHistory
- История используется для прогнозирования

### 4. Kitchen Capacity Timeline

**Интеграция:**
- Прогнозируемая загрузка кухни учитывает планируемые закупки
- Помогает менеджерам планировать закупки в дни высокой загрузки

## Workflow

### Создание плана:

1. Менеджер открывает модуль планирования
2. Выбирает филиал и месяц
3. Система автоматически создает план (если не существует)
4. Загружает матрицу с прогнозами и историей

### Заполнение плана:

1. Менеджер вводит планируемое количество в ячейки
2. При клике на ячейку открывается панель аналитики:
   - Исторические данные
   - Прогноз спроса
   - Рекомендация по поставщику
3. Изменения сохраняются автоматически

### Отправка плана:

1. Менеджер нажимает "Отправить план"
2. Система группирует позиции по дате и поставщику
3. Создаются PurchaseOrders для каждой комбинации
4. План получает статус `submitted`
5. Менеджер видит созданные заказы в модуле "Заказы на закупку"

## Примеры использования

### Пример 1: Создание плана на февраль

```javascript
// 1. Загружаем план
const result = await GetMonthlyProcurementPlan('branch-uuid', '2026', '2');
const data = JSON.parse(result);

// 2. Получаем матрицу
const matrix = data.matrix; // Массив товаров
const dates = data.dates; // ['2026-02-01', '2026-02-02', ...]

// 3. Для каждого товара есть ячейки для каждой даты
matrix.forEach(row => {
  row.cells.forEach(cell => {
    console.log(`${row.nomenclature_name} на ${cell.date}:`);
    console.log(`  Планируемое: ${cell.planned_quantity}`);
    console.log(`  Прогноз: ${cell.forecasted_quantity}`);
    console.log(`  Загрузка: ${cell.predicted_kitchen_load}`);
  });
});
```

### Пример 2: Обновление ячейки

```javascript
// Менеджер вводит количество для муки на 15 февраля
await UpdateProcurementPlanCell(JSON.stringify({
  plan_id: 'plan-uuid',
  nomenclature_id: 'flour-uuid',
  date: '2026-02-15',
  quantity: 12.5
}));
```

### Пример 3: Отправка плана

```javascript
// Система создаст заказы на закупку
await SubmitProcurementPlan(JSON.stringify({
  plan_id: 'plan-uuid',
  created_by: 'manager_username'
}));

// Результат:
// - Создано N заказов (по количеству уникальных комбинаций дата × поставщик)
// - План получил статус 'submitted'
```

## Технические детали

### Производительность

**Оптимизации:**
- Индексы на `procurement_history(branch_id, nomenclature_id, day_of_week, delivery_date)`
- Кэширование прогнозов (TTL: 7 дней)
- Ленивая загрузка матрицы (только видимые товары)

**Масштабируемость:**
- Для больших объемов данных (1000+ товаров) используется виртуализация строк
- Прогнозы рассчитываются асинхронно в фоне
- История закупок обновляется при получении заказов (не блокирует UI)

### Безопасность

**Права доступа:**
- Менеджеры филиалов: могут создавать и редактировать планы своего филиала
- Менеджеры по закупкам: могут просматривать все планы, утверждать
- Администраторы: полный доступ

## Roadmap (будущие улучшения)

### Phase 1: Базовый функционал (текущая реализация)
- ✅ Матрица планирования
- ✅ Прогнозирование на основе истории
- ✅ Автоматическое создание PurchaseOrders
- ✅ Панель аналитики

### Phase 2: Расширенная аналитика
- [ ] Интеграция с фактическими продажами
- [ ] Анализ отклонений (план vs факт)
- [ ] Рекомендации по оптимизации закупок
- [ ] Визуализация трендов

### Phase 3: Machine Learning
- [ ] ML модель для прогнозирования
- [ ] Автоматическая корректировка коэффициентов
- [ ] Учет внешних факторов (праздники, погода)

### Phase 4: Автоматизация
- [ ] Автоматическое создание плана на основе прогноза
- [ ] Умные рекомендации по количеству
- [ ] Интеграция с системой управления запасами (автозаказ)



