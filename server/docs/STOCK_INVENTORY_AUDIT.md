# –ê—É–¥–∏—Ç –º–æ–¥—É–ª—è Stock Service –∏ Inventory

**–î–∞—Ç–∞:** 2026-02-07  
**–≠–∫—Å–ø–µ—Ä—Ç:** –°–∏—Å—Ç–µ–º–Ω—ã–π –∞—É–¥–∏—Ç —Å–∫–ª–∞–¥—Å–∫–æ–≥–æ —É—á–µ—Ç–∞  
**–í–µ—Ä—Å–∏—è:** 1.0

---

## üìã Executive Summary

–ü—Ä–æ–≤–µ–¥–µ–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –º–æ–¥—É–ª—è Stock Service –∏ Inventory –≤ ERP-—Å–∏—Å—Ç–µ–º–µ –¥–ª—è –ø–∏—Ü—Ü–µ—Ä–∏–π. –í—ã—è–≤–ª–µ–Ω—ã **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã** –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–∞—Ö, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è –¥–æ–ø–æ–≤, –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø  
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥

---

## üîç 1. –ü–†–ò–•–û–î (INBOUND) - –¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ –∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:

1. **–§–∏–∫—Å–∞—Ü–∏—è —Ü–µ–Ω—ã –∑–∞–∫—É–ø–∫–∏:**
   - ‚úÖ `StockBatch.CostPerUnit` - —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏–∏
   - ‚úÖ `NomenclatureItem.LastPrice` - –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –ø–æ—Å—Ç–∞–≤–∫–µ
   - ‚úÖ –°–≤—è–∑—å —Å –Ω–∞–∫–ª–∞–¥–Ω–æ–π —á–µ—Ä–µ–∑ `InvoiceID`

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö:**
   - ‚úÖ `ProcessInboundInvoice()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Ç–∏–∏
   - ‚úÖ –°–æ–∑–¥–∞–µ—Ç `StockMovement` —Å —Ç–∏–ø–æ–º "invoice"
   - ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
   - ‚úÖ –°–æ–∑–¥–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ `FinanceService.CreateExpenseFromInvoice()`

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1.1. –ù–µ—Ç –º–µ—Ç–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (FIFO/LIFO/–°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `LastPrice` –∏–∑ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã, –∞ –Ω–µ —Ä–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –ø–∞—Ä—Ç–∏–∏.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (CalculatePrimeCost:471):**
```go
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LastPrice, –∞ –Ω–µ —Ü–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä—Ç–∏–∏
pricePerGram := nomenclature.LastPrice / 1000.0 // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ LastPrice –∑–∞ –∫–≥
ingredientCost = pricePerGram * ingredient.Quantity
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω
- ‚ùå –ï—Å–ª–∏ –º—É–∫–∞ –±—ã–ª–∞ –∫—É–ø–ª–µ–Ω–∞ –ø–æ 50‚ÇΩ/–∫–≥, –∞ –ø–æ—Ç–æ–º –ø–æ 60‚ÇΩ/–∫–≥, —Å–∏—Å—Ç–µ–º–∞ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 60‚ÇΩ
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è:**
```
–ü–∞—Ä—Ç–∏—è 1: –ú—É–∫–∞ 100–∫–≥ –ø–æ 50‚ÇΩ/–∫–≥ (CostPerUnit = 50)
–ü–∞—Ä—Ç–∏—è 2: –ú—É–∫–∞ 100–∫–≥ –ø–æ 60‚ÇΩ/–∫–≥ (CostPerUnit = 60)
LastPrice = 60‚ÇΩ

–ó–∞–∫–∞–∑ —Ç—Ä–µ–±—É–µ—Ç 50–∫–≥ –º—É–∫–∏:
- –†–µ–∞–ª—å–Ω–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (FIFO): 50–∫–≥ √ó 50‚ÇΩ = 2500‚ÇΩ
- –†–∞—Å—á–µ—Ç–Ω–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (LastPrice): 50–∫–≥ √ó 60‚ÇΩ = 3000‚ÇΩ
- –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: 500‚ÇΩ (–∑–∞–≤—ã—à–µ–Ω–∏–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞ 20%)
```

#### 1.2. –ù–µ—Ç —É—á–µ—Ç–∞ –º–µ—Ç–æ–¥–∞ —Å–ø–∏—Å–∞–Ω–∏—è (FIFO/LIFO/–°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FEFO (First Expired First Out) –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –ø–∞—Ä—Ç–∏–∏ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (processIngredientDepletion:323-328):**
```go
// ‚úÖ FEFO –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
Order("COALESCE(expiry_at, '9999-12-31') ASC"). // –°–Ω–∞—á–∞–ª–∞ —Å –±–ª–∏–∂–∞–π—à–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏
```

**–ù–æ:**
- ‚ùå –ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `CostPerUnit` –∏–∑ —Å–ø–∏—Å–∞–Ω–Ω–æ–π –ø–∞—Ä—Ç–∏–∏
- ‚ùå –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ç–æ–¥–∞ —Å–ø–∏—Å–∞–Ω–∏—è (FIFO/LIFO/–°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

#### –†–µ—à–µ–Ω–∏–µ 1.1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—É –ø–∞—Ä—Ç–∏–∏ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏

```go
// –í CalculatePrimeCost - –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏—è—Ö
func (s *StockService) CalculatePrimeCostWithBatches(recipeID string, branchID string, quantity float64) (float64, error) {
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ü–µ–ø—Ç
    var recipe models.Recipe
    if err := s.db.Preload("Ingredients").Preload("Ingredients.Nomenclature").
        First(&recipe, "id = ?", recipeID).Error; err != nil {
        return 0, err
    }

    totalCost := 0.0
    
    for _, ingredient := range recipe.Ingredients {
        if ingredient.NomenclatureID == nil {
            continue
        }
        
        requiredQuantity := ingredient.Quantity * quantity // –í –≥—Ä–∞–º–º–∞—Ö
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–∞—Ä—Ç–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–ø–∏—Å–∞–Ω—ã (FEFO)
        var batches []models.StockBatch
        s.db.Where("nomenclature_id = ? AND branch_id = ? AND remaining_quantity > 0",
            *ingredient.NomenclatureID, branchID).
            Order("COALESCE(expiry_at, '9999-12-31') ASC").
            Find(&batches)
        
        remainingToCalculate := requiredQuantity
        ingredientCost := 0.0
        
        for _, batch := range batches {
            if remainingToCalculate <= 0 {
                break
            }
            
            deductQuantity := remainingToCalculate
            if batch.RemainingQuantity < deductQuantity {
                deductQuantity = batch.RemainingQuantity
            }
            
            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä—Ç–∏–∏
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º CostPerUnit –≤ —Ü–µ–Ω—É –∑–∞ –≥—Ä–∞–º–º
            var pricePerGram float64
            if batch.Unit == "kg" {
                pricePerGram = batch.CostPerUnit / 1000.0
            } else if batch.Unit == "g" {
                pricePerGram = batch.CostPerUnit
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º LastPrice –∫–∞–∫ fallback
                pricePerGram = batch.Nomenclature.LastPrice / 1000.0
            }
            
            ingredientCost += pricePerGram * deductQuantity
            remainingToCalculate -= deductQuantity
        }
        
        totalCost += ingredientCost
    }
    
    return totalCost, nil
}
```

#### –†–µ—à–µ–Ω–∏–µ 1.2: –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –º–µ—Ç–æ–¥–∞ —Å–ø–∏—Å–∞–Ω–∏—è

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É branches –∏–ª–∏ settings
ALTER TABLE branches ADD COLUMN IF NOT EXISTS cost_method VARCHAR(20) DEFAULT 'FIFO';
-- –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: 'FIFO', 'LIFO', 'WEIGHTED_AVERAGE'
```

```go
// –í StockService
type CostMethod string

const (
    CostMethodFIFO            CostMethod = "FIFO"
    CostMethodLIFO            CostMethod = "LIFO"
    CostMethodWeightedAverage CostMethod = "WEIGHTED_AVERAGE"
)

func (s *StockService) getCostMethod(branchID string) CostMethod {
    var branch models.Branch
    s.db.Select("cost_method").First(&branch, "id = ?", branchID)
    
    if branch.CostMethod == "" {
        return CostMethodFIFO // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
    return CostMethod(branch.CostMethod)
}
```

---

## üîç 2. –°–ü–ò–°–ê–ù–ò–ï (OUTBOUND) - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 2.1. –ù–ï–¢ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** `ProcessSaleDepletion()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ **–ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ `order_controller.go`.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (order_controller.go:48-347):**
```go
func (oc *OrderController) CreateOrder(c *gin.Context) {
    // ... —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ...
    // ‚ùå –ù–ï–¢ –≤—ã–∑–æ–≤–∞ ProcessSaleDepletion!
    // ‚ùå –ù–ï–¢ —Å–ø–∏—Å–∞–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤!
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- üî¥ **–ö–†–ò–¢–ò–ß–ù–û:** –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ
- üî¥ –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏
- üî¥ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
- üî¥ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å:**
```go
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ (status = "confirmed")
if order.Status == "confirmed" {
    for _, item := range order.Items {
        // –ü–æ–ª—É—á–∞–µ–º recipe_id –¥–ª—è –ø–∏—Ü—Ü—ã
        recipeID := GetRecipeIDByPizzaName(item.PizzaName)
        
        // –°–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
        stockService.ProcessSaleDepletion(
            recipeID,
            float64(item.Quantity),
            order.BranchID,
            "system",
            order.ID,
        )
    }
}
```

#### 2.2. –ù–ï–¢ —Å–ø–∏—Å–∞–Ω–∏—è –¥–æ–ø–æ–≤ (Extras)

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–ø—ã –∏–º–µ—é—Ç —Å–≤—è–∑—å —Å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–æ–π (`ExtraDB.NomenclatureID` –∏–ª–∏ `ExtraDB.RecipeID`), –Ω–æ **–ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è** –ø—Ä–∏ –∑–∞–∫–∞–∑–µ.

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```go
type ExtraDB struct {
    NomenclatureID *string // ‚úÖ –ï—Å—Ç—å —Å–≤—è–∑—å
    RecipeID       *string // ‚úÖ –ï—Å—Ç—å —Å–≤—è–∑—å
    // –ù–æ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –¥–æ–ø—ã –ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è!
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- üî¥ "–î–æ–ø. —Å—ã—Ä" –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å–∫–ª–∞–¥–∞
- üî¥ "–°—ã—Ä–Ω—ã–π –±–æ—Ä—Ç" (—Å–ª–æ–∂–Ω—ã–π –¥–æ–ø —Å —Ä–µ—Ü–µ–ø—Ç–æ–º) –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
- üî¥ –û—Å—Ç–∞—Ç–∫–∏ –¥–æ–ø–æ–≤ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å:**
```go
// –í CreateOrder, –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è –ø–∏—Ü—Ü—ã
for _, item := range order.Items {
    // –°–ø–∏—Å—ã–≤–∞–µ–º –¥–æ–ø—ã
    for _, extraID := range item.Extras {
        extra := GetExtraByID(extraID)
        
        if extra.NomenclatureID != nil {
            // –ü—Ä–æ—Å—Ç–æ–π –¥–æ–ø - —Å–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
            stockService.DebitIngredients(
                extra.NomenclatureID,
                order.BranchID,
                extra.PortionWeightGrams * float64(item.Quantity),
                "system",
            )
        } else if extra.RecipeID != nil {
            // –°–ª–æ–∂–Ω—ã–π –¥–æ–ø - —Å–ø–∏—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —Ä–µ—Ü–µ–ø—Ç
            stockService.ProcessSaleDepletion(
                extra.RecipeID,
                float64(item.Quantity),
                order.BranchID,
                "system",
                order.ID,
            )
        }
    }
}
```

#### 2.3. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ —Å–ø–∏—Å–∞–Ω—ã (–æ—Å—Ç–∞—Ç–∫–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ)
- ‚ùå –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞
- ‚ùå –ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

#### –†–µ—à–µ–Ω–∏–µ 2.1: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –≤ CreateOrder

```go
func (oc *OrderController) CreateOrder(c *gin.Context) {
    // ... –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ...
    
    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
    if order.Status == "confirmed" {
        // –°–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∏—Ü—Ü—ã
        for _, item := range order.Items {
            // –ü–æ–ª—É—á–∞–µ–º recipe_id –¥–ª—è –ø–∏—Ü—Ü—ã
            recipeID, err := oc.getRecipeIDByPizzaName(item.PizzaName)
            if err != nil {
                log.Printf("‚ö†Ô∏è –†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–∏—Ü—Ü—ã '%s': %v", item.PizzaName, err)
                continue
            }
            
            // –°–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø–∏—Ü—Ü—ã
            if oc.stockService != nil {
                if err := oc.stockService.ProcessSaleDepletion(
                    recipeID,
                    float64(item.Quantity),
                    order.BranchID,
                    "system",
                    order.ID,
                ); err != nil {
                    log.Printf("‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è '%s': %v", item.PizzaName, err)
                    // –ù–ï –æ—Ç–º–µ–Ω—è–µ–º –∑–∞–∫–∞–∑, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                }
            }
            
            // –°–ø–∏—Å—ã–≤–∞–µ–º –¥–æ–ø—ã
            for _, extraID := range item.Extras {
                if err := oc.processExtraDepletion(extraID, item.Quantity, order.BranchID, order.ID); err != nil {
                    log.Printf("‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –¥–æ–ø–∞ %d: %v", extraID, err)
                }
            }
        }
    }
}

func (oc *OrderController) processExtraDepletion(extraID int, quantity int, branchID string, orderID string) error {
    // –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø
    extra, exists := models.GetExtraByID(extraID)
    if !exists {
        return fmt.Errorf("–¥–æ–ø —Å ID %d –Ω–µ –Ω–∞–π–¥–µ–Ω", extraID)
    }
    
    if extra.NomenclatureID != nil {
        // –ü—Ä–æ—Å—Ç–æ–π –¥–æ–ø - —Å–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
        return oc.stockService.DebitIngredients(
            *extra.NomenclatureID,
            branchID,
            float64(extra.PortionWeightGrams * quantity),
            "system",
        )
    } else if extra.RecipeID != nil {
        // –°–ª–æ–∂–Ω—ã–π –¥–æ–ø - —Å–ø–∏—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —Ä–µ—Ü–µ–ø—Ç
        return oc.stockService.ProcessSaleDepletion(
            *extra.RecipeID,
            float64(quantity),
            branchID,
            "system",
            orderID,
        )
    }
    
    return nil
}
```

#### –†–µ—à–µ–Ω–∏–µ 2.2: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞

```go
func (oc *OrderController) checkInventoryAvailability(items []models.PizzaItem, branchID string) error {
    for _, item := range items {
        recipeID, err := oc.getRecipeIDByPizzaName(item.PizzaName)
        if err != nil {
            return fmt.Errorf("—Ä–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è '%s': %w", item.PizzaName, err)
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        if err := oc.stockService.CheckRecipeAvailability(recipeID, float64(item.Quantity), branchID); err != nil {
            return fmt.Errorf("–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è '%s': %w", item.PizzaName, err)
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–ø–æ–≤
        for _, extraID := range item.Extras {
            if err := oc.checkExtraAvailability(extraID, item.Quantity, branchID); err != nil {
                return fmt.Errorf("–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–ø–∞: %w", err)
            }
        }
    }
    
    return nil
}
```

---

## üîç 3. –°–í–Ø–ó–¨ –° –§–ò–ù–ê–ù–°–ê–ú–ò

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
   - ‚úÖ `ProcessInboundInvoice()` –≤—ã–∑—ã–≤–∞–µ—Ç `FinanceService.CreateExpenseFromInvoice()`
   - ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è `FinanceTransaction` —Ç–∏–ø–∞ "Expense"
   - ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞

**–ö–æ–¥ (stock_service.go:1320-1333):**
```go
// ‚úÖ –°–æ–∑–¥–∞–µ–º Expense —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
_, err := s.financeService.CreateExpenseFromInvoice(
    invoiceID,
    counterpartyID,
    totalAmount,
    branchID,
    parsedDate,
    isPaidCash,
    performedBy,
)
```

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 3.1. –ù–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ (COGS)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (Cost of Goods Sold).

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ù–µ—Ç —É—á–µ—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º –º–æ–¥—É–ª–µ
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤–∞–ª–æ–≤—É—é –ø—Ä–∏–±—ã–ª—å
- ‚ùå –ù–µ—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø—Ä–æ–¥–∞–∂–µ–π –∏ —Ä–∞—Å—Ö–æ–¥–æ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å:**
```go
// –ü–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
primeCost := stockService.CalculatePrimeCostWithBatches(recipeID, branchID, quantity)
if primeCost > 0 {
    financeService.CreateCOGSTransaction(
        orderID,
        branchID,
        primeCost,
        time.Now(),
    )
}
```

---

## üîç 4. –ï–î–ò–ù–ò–¶–´ –ò–ó–ú–ï–†–ï–ù–ò–Ø

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:

1. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü:**
   - ‚úÖ `convertToBaseUnit()` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é g‚Üîkg, ml‚Üîl
   - ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —à—Ç—É–∫ (pcs) –≤ –≥—Ä–∞–º–º—ã —á–µ—Ä–µ–∑ `UnitWeight`
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `ConversionFactor` –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü

**–ö–æ–¥ (stock_service.go:876-934):**
```go
// ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è g ‚Üî kg
if fromUnit == "g" && nomenclature.BaseUnit == "kg" {
    return quantity / 1000.0, nil
}
```

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 4.1. –ü–æ—Ç–µ—Ä—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `float64` –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é –æ—à–∏–±–æ–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è.

**–ü—Ä–∏–º–µ—Ä:**
```go
// 1000 –≥—Ä–∞–º–º = 1 –∫–≥
grams := 1000.0
kg := grams / 1000.0 // = 1.0 ‚úÖ

// –ù–æ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö:
totalGrams := 0.0
for i := 0; i < 1000; i++ {
    totalGrams += 1.0 // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ 1 –≥—Ä–∞–º–º—É
}
kg := totalGrams / 1000.0 // –ú–æ–∂–µ—Ç –±—ã—Ç—å 0.9999999999999999 –∏–∑-–∑–∞ float64
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```go
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å decimal –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
import "github.com/shopspring/decimal"

func (s *StockService) convertToBaseUnitDecimal(quantity decimal.Decimal, fromUnit string, nomenclature models.NomenclatureItem) (decimal.Decimal, error) {
    if fromUnit == "g" && nomenclature.BaseUnit == "kg" {
        return quantity.Div(decimal.NewFromInt(1000)), nil
    }
    // ...
}
```

#### 4.2. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤ —Ä–µ—Ü–µ–ø—Ç–µ —É–∫–∞–∑–∞–Ω–∞ –µ–¥–∏–Ω–∏—Ü–∞ "–∫–≥", –∞ –≤ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ –±–∞–∑–æ–≤–∞—è –µ–¥–∏–Ω–∏—Ü–∞ "–≥", —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ—Ç —è–≤–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```go
// –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ RecipeIngredient
func ValidateRecipeIngredientUnit(ingredientUnit string, nomenclature models.NomenclatureItem) error {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
    _, err := convertToBaseUnit(1.0, ingredientUnit, nomenclature)
    if err != nil {
        return fmt.Errorf("–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è '%s' –¥–ª—è —Ç–æ–≤–∞—Ä–∞ '%s' (–±–∞–∑–æ–≤–∞—è –µ–¥–∏–Ω–∏—Ü–∞: %s)", 
            ingredientUnit, nomenclature.Name, nomenclature.BaseUnit)
    }
    return nil
}
```

---

## üîç 5. –ò–ù–í–ï–ù–¢–ê–†–ò–ó–ê–¶–ò–Ø

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –û–¢–°–£–¢–°–¢–í–£–ï–¢ –ª–æ–≥–∏–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Å–∏—Å—Ç–µ–º–µ **–ù–ï–¢** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–ª—è:
- –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ (—Ä–µ–∞–ª—å–Ω—ã–π –≤–µ—Å ‚â† —Å–∏—Å—Ç–µ–º–Ω—ã–π)
- –°–æ–∑–¥–∞–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π
- –£—á–µ—Ç–∞ –Ω–µ–¥–æ—Å—Ç–∞—á/–∏–∑–ª–∏—à–∫–æ–≤

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- üî¥ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –æ—Å—Ç–∞—Ç–∫–∞—Ö
- üî¥ –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
- üî¥ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

#### –†–µ—à–µ–Ω–∏–µ 5.1: –î–æ–±–∞–≤–∏—Ç—å API –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏

```go
// POST /api/v1/inventory/stock/inventory-adjustment
type InventoryAdjustmentRequest struct {
    BranchID        string                   `json:"branch_id" binding:"required"`
    Items           []InventoryAdjustmentItem `json:"items" binding:"required"`
    PerformedBy     string                   `json:"performed_by" binding:"required"`
    Reason          string                   `json:"reason"` // "inventory", "waste", "theft", "found"
    Notes           string                   `json:"notes"`
}

type InventoryAdjustmentItem struct {
    NomenclatureID string  `json:"nomenclature_id" binding:"required"`
    SystemQuantity float64 `json:"system_quantity"` // –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
    ActualQuantity  float64 `json:"actual_quantity" binding:"required"` // –†–µ–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫
    Unit           string  `json:"unit" binding:"required"`
}

func (sc *StockController) CreateInventoryAdjustment(c *gin.Context) {
    var req InventoryAdjustmentRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
    for _, item := range req.Items {
        difference := item.ActualQuantity - item.SystemQuantity
        
        if difference == 0 {
            continue // –ù–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è
        }
        
        movementType := "adjustment"
        if difference < 0 {
            movementType = "waste" // –ù–µ–¥–æ—Å—Ç–∞—á–∞
        }
        
        movement := models.StockMovement{
            NomenclatureID: item.NomenclatureID,
            BranchID:       req.BranchID,
            Quantity:       difference, // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ = –ø—Ä–∏—Ö–æ–¥, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ = —Ä–∞—Å—Ö–æ–¥
            Unit:           item.Unit,
            MovementType:   movementType,
            PerformedBy:    req.PerformedBy,
            Notes:          fmt.Sprintf("–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: %s. –°–∏—Å—Ç–µ–º–∞: %.2f, –§–∞–∫—Ç: %.2f", req.Reason, item.SystemQuantity, item.ActualQuantity),
        }
        
        if err := sc.stockService.CreateStockMovement(&movement); err != nil {
            c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
            return
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–∞—Ä—Ç–∏–π (FIFO)
        sc.stockService.AdjustStockBatches(item.NomenclatureID, req.BranchID, difference)
    }
    
    c.JSON(http.StatusOK, gin.H{"message": "–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞"})
}
```

#### –†–µ—à–µ–Ω–∏–µ 5.2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö

```go
// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
func (s *StockService) CheckStockDiscrepancies(branchID string, thresholdPercent float64) ([]StockDiscrepancy, error) {
    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–≤–∏–∂–µ–Ω–∏–π)
    // –ï—Å–ª–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ > thresholdPercent, –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
}
```

---

## üìä 6. –ü–†–ò–û–†–ò–¢–ï–¢–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ (Phase 0 - –°–†–û–ß–ù–û):

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∞–Ω–∏—è –≤ CreateOrder**
   - **–†–∏—Å–∫:** –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è ‚Üí —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –æ—Å—Ç–∞—Ç–∫–∞—Ö
   - **–£—Å–∏–ª–∏–µ:** M (3-5 –¥–Ω–µ–π)
   - **–ë–ª–æ–∫–∏—Ä—É–µ—Ç:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Å—Ç–∞—Ç–∫–æ–≤

2. **–°–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ø–æ–≤ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ**
   - **–†–∏—Å–∫:** –î–æ–ø—ã –Ω–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è ‚Üí –Ω–µ–≤–µ—Ä–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏
   - **–£—Å–∏–ª–∏–µ:** S (2-3 –¥–Ω—è)
   - **–ë–ª–æ–∫–∏—Ä—É–µ—Ç:** –ü–æ–ª–Ω–æ—Ç—É —Å–ø–∏—Å–∞–Ω–∏—è

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã –ø–∞—Ä—Ç–∏–∏ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏**
   - **–†–∏—Å–∫:** –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏
   - **–£—Å–∏–ª–∏–µ:** M (3-5 –¥–Ω–µ–π)
   - **–ë–ª–æ–∫–∏—Ä—É–µ—Ç:** –§–∏–Ω–∞–Ω—Å–æ–≤—É—é –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å

### üü° –í–∞–∂–Ω–æ (Phase 1):

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞**
   - **–£—Å–∏–ª–∏–µ:** S (2 –¥–Ω—è)
   - **–ë–ª–æ–∫–∏—Ä—É–µ—Ç:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤

5. **–õ–æ–≥–∏–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏**
   - **–£—Å–∏–ª–∏–µ:** M (3-5 –¥–Ω–µ–π)
   - **–ë–ª–æ–∫–∏—Ä—É–µ—Ç:** –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤

6. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ COGS**
   - **–£—Å–∏–ª–∏–µ:** S (2 –¥–Ω—è)
   - **–ë–ª–æ–∫–∏—Ä—É–µ—Ç:** –£—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö

### üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (Phase 2):

7. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ—Ç–æ–¥–∞ —Å–ø–∏—Å–∞–Ω–∏—è (FIFO/LIFO/–°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)**
   - **–£—Å–∏–ª–∏–µ:** M (3-5 –¥–Ω–µ–π)

8. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ decimal –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤**
   - **–£—Å–∏–ª–∏–µ:** S (2 –¥–Ω—è)

---

## üéØ 7. –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –ù–µ–¥–µ–ª—è 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `ProcessSaleDepletion` –≤ `CreateOrder`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ø–æ–≤ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—É –ø–∞—Ä—Ç–∏–∏)

### –ù–µ–¥–µ–ª—è 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ COGS

### –ù–µ–¥–µ–ª—è 3: –£–ª—É—á—à–µ–Ω–∏—è
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ—Ç–æ–¥–∞ —Å–ø–∏—Å–∞–Ω–∏—è
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ decimal –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è

---

## üìù 8. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### 8.1. –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø–∏—Å–∞–Ω–∏—è

```
CreateOrder (order_controller.go)
  ‚Üì
  ‚ùå –ù–ï–¢ –≤—ã–∑–æ–≤–∞ ProcessSaleDepletion
  ‚Üì
  –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ù–ï —Å–ø–∏—Å–∞–Ω—ã
```

### 8.2. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
CreateOrder (order_controller.go)
  ‚Üì
  checkInventoryAvailability() // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
  ‚Üì
  –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  ‚Üì
  ProcessSaleDepletion() // –°–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –ø–∏—Ü—Ü—ã
  ‚Üì
  processExtraDepletion() // –°–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ø–æ–≤
  ‚Üì
  CreateCOGSTransaction() // –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
```

### 8.3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏

```sql
-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
CREATE TABLE IF NOT EXISTS inventory_adjustments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    branch_id UUID NOT NULL REFERENCES branches(id),
    performed_by VARCHAR(255) NOT NULL,
    reason VARCHAR(50) NOT NULL, -- 'inventory', 'waste', 'theft', 'found'
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (branch_id) REFERENCES branches(id)
);

-- –°–≤—è–∑—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π —Å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–µ–π
ALTER TABLE stock_movements ADD COLUMN IF NOT EXISTS adjustment_id UUID REFERENCES inventory_adjustments(id);
```

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Stock Service –∏–º–µ–µ—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã** –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–∞—Ö. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ (Phase 0), –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è –¥–æ–ø–æ–≤ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏.

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤:**
- üî¥ **–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –æ—Å—Ç–∞—Ç–∫–∞—Ö:** –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è ‚Üí –Ω–µ–≤–µ—Ä–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏
- üî¥ **–ù–µ–≤–µ—Ä–Ω–∞—è –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LastPrice –≤–º–µ—Å—Ç–æ —Ü–µ–Ω—ã –ø–∞—Ä—Ç–∏–∏ ‚Üí –∑–∞–≤—ã—à–µ–Ω–∏–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
- üü° **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ ‚Üí –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
- üü° **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ COGS:** –ù–µ—Ç —É—á–µ—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö ‚Üí –Ω–µ–≤–µ—Ä–Ω–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** Phase 0 ‚Üí Phase 1 ‚Üí Phase 2

