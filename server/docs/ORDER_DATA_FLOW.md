# Data Flow: –û—Ç –∫–ª–∏–∫–∞ "–ó–∞–∫–∞–∑–∞—Ç—å" –¥–æ KDS-—ç–∫—Ä–∞–Ω–∞ –ø–æ–≤–∞—Ä–∞

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ü–æ—à–∞–≥–æ–≤—ã–π Data Flow](#–ø–æ—à–∞–≥–æ–≤—ã–π-data-flow)
3. [–†–æ–ª—å –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞](#—Ä–æ–ª—å-–∫–∞–∂–¥–æ–≥–æ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞)
4. [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-redis)
5. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
6. [–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö](#–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å-–¥–∞–Ω–Ω—ã—Ö)
7. [–î–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Ç–æ–∫–æ–≤](#–¥–∏–∞–≥—Ä–∞–º–º—ã-–ø–æ—Ç–æ–∫–æ–≤)

---

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: Event-Driven, HighLoad, Real-time

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- **Go gRPC API** - –ø—Ä–∏–µ–º –∑–∞–∫–∞–∑–æ–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
- **PostgreSQL** - –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–∫–∞–∑–æ–≤
- **Kafka** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ø–∏–∫: `pizza-orders`)
- **Redis** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **WebSocket Hub** - real-time –¥–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ KDS-—ç–∫—Ä–∞–Ω—ã
- **Kafka Consumer** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Kafka

**Consumer Group**: `order-service-stable-group`

---

## üîÑ –ü–æ—à–∞–≥–æ–≤—ã–π Data Flow

### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–∫–∞–∑–∞—Ç—å"

**–î–µ–π—Å—Ç–≤–∏–µ**: –ö–ª–∏–µ–Ω—Ç (–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤–µ–±-—Å–∞–π—Ç) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç gRPC –∑–∞–ø—Ä–æ—Å

**–ó–∞–ø—Ä–æ—Å**:
```protobuf
PizzaOrderRequest {
    CustomerId: 12345
    PizzaName: "–ü–∏—Ü—Ü–∞ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è"
    Quantity: 2
    CustomerFirstName: "–ò–≤–∞–Ω"
    CustomerLastName: "–ò–≤–∞–Ω–æ–≤"
    CustomerPhone: "+79001234567"
    DeliveryAddress: "—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1"
    IsPickup: false
}
```

**–ö—É–¥–∞**: `OrderGRPCServer.CreateOrder()` (–ø–æ—Ä—Ç 50051)

---

### –®–∞–≥ 2: Go gRPC API - –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `OrderGRPCServer` (`internal/api/grpc_order_server.go`)

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∑–∞–∫–∞–∑–∞**:
   - –°–æ–∑–¥–∞–µ—Ç—Å—è UUID: `85880f99-90c6-4402-b0df-33b15f51638b`
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è DisplayID: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã UUID (–Ω–∞–ø—Ä–∏–º–µ—Ä, `384b`)

2. **–†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã**:
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ü–µ–Ω–∞ –ø–∏—Ü—Ü—ã –∏–∑ –º–µ–Ω—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, 962‚ÇΩ)
   - –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ–±—â–∞—è —Ü–µ–Ω–∞: `price * quantity` (962‚ÇΩ √ó 2 = 1924‚ÇΩ)

3. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤**:
   - –ò–∑ –º–æ–¥–µ–ª–∏ –ø–∏—Ü—Ü—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –¥–æ–∑–∏—Ä–æ–≤–∫–∏
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ `PizzaItem` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

4. **Capacity-Based Slot Scheduling**:
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `SlotService.AssignSlot(orderID, totalPrice, itemsCount)`
   - **–õ–æ–≥–∏–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–ª–æ—Ç–∞**:
     - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –∫—É—Ö–Ω—è (—Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã)
     - –ù–∞—Ö–æ–¥–∏—Ç—Å—è –±–ª–∏–∂–∞–π—à–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–ª–æ—Ç (15-–º–∏–Ω—É—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã)
     - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –µ–º–∫–æ—Å—Ç—å —Å–ª–æ—Ç–∞ –≤ Redis —á–µ—Ä–µ–∑ Lua script (–∞—Ç–æ–º–∞—Ä–Ω–æ)
     - –ï—Å–ª–∏ —Å–ª–æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –∏—â–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è: `slotID`, `slotStartTime`, `visibleAt`

5. **–°–æ–∑–¥–∞–Ω–∏–µ Protobuf –∑–∞–∫–∞–∑–∞**:
   ```go
   pbOrder := &pb.PizzaOrder{
       Id: "85880f99-90c6-4402-b0df-33b15f51638b",
       DisplayId: "384b",
       TotalPrice: 1924,
       Status: "pending",
       TargetSlotId: "slot:1770390000",
       VisibleAt: "2026-02-06T15:30:00Z", // –ó–∞ 30 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞ —Å–ª–æ—Ç–∞
       Items: [...]
   }
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: Protobuf –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ

---

### –®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –±—ã—Å—Ç—Ä–æ)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: Redis Pipeline (–∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **–°–æ–∑–¥–∞–Ω–∏–µ Pipeline** (–±–∞—Ç—á –æ–ø–µ—Ä–∞—Ü–∏–π):
   ```go
   pipe := redisUtil.Pipeline()
   ```

2. **–û–ø–µ—Ä–∞—Ü–∏–∏ –≤ Pipeline**:
   - `SET erp:order:{id}` - –∑–∞–∫–∞–∑ –≤ Protobuf —Ñ–æ—Ä–º–∞—Ç–µ (TTL: 24 —á–∞—Å–∞)
   - `SET order:slot:start:{id}` - –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–ª–æ—Ç–∞ (TTL: 24 —á–∞—Å–∞)
   - `LPUSH kitchen:orders:queue {id}` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å –∫—É—Ö–Ω–∏
   - `INCR orders:total` - —Å—á–µ—Ç—á–∏–∫ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
   - `INCR erp:orders:pending` - —Å—á–µ—Ç—á–∏–∫ pending –∑–∞–∫–∞–∑–æ–≤

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ pending_slots**:
   - –ï—Å–ª–∏ `visibleAt` –≤ –±—É–¥—É—â–µ–º:
     - `SET order:visible_at:{id}` - –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –∑–∞–∫–∞–∑–∞
     - `SADD erp:orders:pending_slots {id}` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö

4. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Pipeline**:
   ```go
   pipe.Exec(ctx) // –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Redis, –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —á—Ç–µ–Ω–∏—è

**–ü–æ—á–µ–º—É Redis –ø–µ—Ä–≤—ã–º?**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (< 1ms)
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è real-time –æ–ø–µ—Ä–∞—Ü–∏–π

---

### –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: Kafka Producer (`kafka.Writer`)

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ Protobuf**:
   ```go
   orderBytes, _ := proto.Marshal(pbOrder)
   ```

2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞**:
   ```go
   go func() {
       kafkaWriter.WriteMessages(ctx, kafka.Message{
           Topic: "pizza-orders",
           Key: []byte(orderID),
           Value: orderBytes, // –ë–∏–Ω–∞—Ä–Ω—ã–π Protobuf
       })
   }()
   ```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã Kafka**:
- **–¢–æ–ø–∏–∫**: `pizza-orders`
- **–§–æ—Ä–º–∞—Ç**: Protobuf (–±–∏–Ω–∞—Ä–Ω—ã–π, –±—ã—Å—Ç—Ä–µ–µ JSON –≤ 2-3 —Ä–∞–∑–∞)
- **Async**: `true` (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç)
- **Balancer**: `LeastBytes` (–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Kafka, –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç

**–û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É**:
```protobuf
OrderResponse {
    OrderId: "85880f99-90c6-4402-b0df-33b15f51638b"
    DisplayId: "384b"
    SlotStartTime: "2026-02-06T16:00:00Z"
    EstimatedTime: "2026-02-06T16:00:00Z"
}
```

---

### –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `OrderService.SaveOrderWithTransaction()`

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **–ó–∞–ø—É—Å–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ**:
   ```go
   go func() {
       orderService.SaveOrder(order)
   }()
   ```

2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å SERIALIZABLE –∏–∑–æ–ª—è—Ü–∏–µ–π**:
   ```sql
   BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
   
   INSERT INTO orders (
       id, display_id, customer_id, items, total_price,
       status, created_at, target_slot_id, target_slot_start_time, visible_at
   ) VALUES (
       '85880f99-90c6-4402-b0df-33b15f51638b',
       '384b',
       12345,
       '{"items": [...]}'::jsonb,
       1924,
       'pending',
       NOW(),
       'slot:1770390000',
       '2026-02-06T16:00:00Z',
       '2026-02-06T15:30:00Z'
   )
   ON CONFLICT (id) DO UPDATE SET ...;
   
   COMMIT;
   ```

3. **Retry –ª–æ–≥–∏–∫–∞**:
   - –ü—Ä–∏ serialization failure - retry —Å exponential backoff (–¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫)
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ PostgreSQL (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

**–ü–æ—á–µ–º—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ?**
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
- PostgreSQL –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ Redis
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å SERIALIZABLE –º–æ–≥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –≤—Ä–µ–º—è

---

### –®–∞–≥ 6: Kafka Consumer - –ß—Ç–µ–Ω–∏–µ –∏–∑ Kafka

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `KafkaWSConsumer` (`internal/api/kafka_ws_consumer.go`)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Consumer**:
- **Consumer Group**: `order-service-stable-group`
- **Topic**: `pizza-orders`
- **StartOffset**: `LastOffset` (–ø–æ—Å–ª–µ bootstrap –∏–∑ –ë–î)
- **CommitInterval**: 5 —Å–µ–∫—É–Ω–¥ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit offset)
- **MinBytes**: 10KB (–±–∞—Ç—á–∏–Ω–≥ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **–ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Kafka**:
   ```go
   msg, err := reader.ReadMessage(ctx)
   // msg.Value —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–Ω–∞—Ä–Ω—ã–π Protobuf
   ```

2. **–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è Protobuf**:
   ```go
   pbOrder := &pb.PizzaOrder{}
   proto.Unmarshal(msg.Value, pbOrder)
   ```

3. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ models.PizzaOrder**:
   - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ Protobuf –≤ Go —Å—Ç—Ä—É–∫—Ç—É—Ä—É
   - –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∑–∏—Ä–æ–≤–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ

---

### –®–∞–≥ 7: Kafka Consumer - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –∏ PostgreSQL

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `KafkaWSConsumer` (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis** (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞):
   ```go
   orderJSON, _ := json.Marshal(order)
   redisUtil.SetBytes("erp:order:{id}", orderJSON, 24*time.Hour)
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ VisibleAt**:
   - –ï—Å–ª–∏ `visibleAt` –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ Redis
   - –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç, –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ `targetSlotStartTime` (–º–∏–Ω—É—Å 15 –º–∏–Ω—É—Ç)

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ pending_slots**:
   ```go
   if !order.VisibleAt.IsZero() && order.VisibleAt.After(now) {
       redisUtil.SAdd("erp:orders:pending_slots", order.ID)
       redisUtil.Set("order:visible_at:{id}", visibleAt, 24*time.Hour)
   }
   ```

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL** (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ):
   ```go
   go func() {
       orderService.SaveOrderWithTransaction(order)
   }()
   ```

5. **Commit offset** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥):
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã –Ω–µ –±—É–¥—É—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Redis –∏ PostgreSQL, –¥–æ–±–∞–≤–ª–µ–Ω –≤ `pending_slots`

---

### –®–∞–≥ 8: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑ pending_slots –≤ active (–ø–æ –≤—Ä–µ–º–µ–Ω–∏)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (–Ω–µ—è–≤–Ω–∞—è, —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É VisibleAt)

**–õ–æ–≥–∏–∫–∞**:

1. **KDS-—ç–∫—Ä–∞–Ω –∏–ª–∏ ERP –ø–∞–Ω–µ–ª—å** –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
2. **–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `visibleAt` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ –≤ `pending_slots`
3. **–ï—Å–ª–∏ `visibleAt <= now`**:
   - –ó–∞–∫–∞–∑ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –∏–∑ `pending_slots` –≤ `active`
   - `SREM erp:orders:pending_slots {id}`
   - `SADD erp:orders:active {id}`

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç**: –û—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `pending_slots` –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –∑–∞–∫–∞–∑—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –ø–æ–∫–∞–∑—É –Ω–∞ KDS

---

### –®–∞–≥ 9: WebSocket Broadcast - –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ KDS-—ç–∫—Ä–∞–Ω

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `GlobalHub` (WebSocket Hub –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –ø–æ–≤–∞—Ä–æ–≤)

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **Kafka Consumer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ WebSocket**:
   ```go
   orderJSON, _ := json.Marshal(order)
   GlobalHub.BroadcastMessage(orderJSON)
   ```

2. **WebSocket Hub –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ**:
   ```go
   func (h *Hub) Run() {
       for {
           msg := <-h.broadcast
           for client := range h.clients {
               client.WriteMessage(websocket.TextMessage, msg)
           }
       }
   }
   ```

3. **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º KDS-—ç–∫—Ä–∞–Ω–∞–º**:
   - –í—Å–µ –ø–ª–∞–Ω—à–µ—Ç—ã –ø–æ–≤–∞—Ä–æ–≤ –ø–æ–ª—É—á–∞—é—Ç JSON —Å–æ–æ–±—â–µ–Ω–∏–µ
   - –§–æ—Ä–º–∞—Ç: `{"id": "...", "items": [...], "status": "pending", ...}`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ KDS-—ç–∫—Ä–∞–Ω—ã

---

### –®–∞–≥ 10: KDS-—ç–∫—Ä–∞–Ω - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: KDS UI (Wails/Svelte –∏–ª–∏ –Ω–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)

**–î–µ–π—Å—Ç–≤–∏—è**:

1. **WebSocket –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ**:
   ```javascript
   ws.onmessage = (event) => {
       const order = JSON.parse(event.data);
       displayOrder(order);
   }
   ```

2. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ**:
   - –ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞, –ø–∏—Ü—Ü—ã, –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, –≤—Ä–µ–º—è —Å–ª–æ—Ç–∞
   - –°—Ç–∞—Ç—É—Å: `pending` ‚Üí `preparing` ‚Üí `cooking` ‚Üí `ready`

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–≤–∞—Ä–æ–º):
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ REST API: `PUT /api/v1/erp/orders/{id}/status`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Redis –∏ PostgreSQL
   - Broadcast —á–µ—Ä–µ–∑ WebSocket –≤—Å–µ–º KDS-—ç–∫—Ä–∞–Ω–∞–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–∫–∞–∑ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ KDS-—ç–∫—Ä–∞–Ω–µ –ø–æ–≤–∞—Ä–∞

---

## üèó –†–æ–ª—å –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

### 1. Go gRPC API (`OrderGRPCServer`)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:
- ‚úÖ –ü—Ä–∏–µ–º –∑–∞–∫–∞–∑–æ–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
- ‚úÖ –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ (Capacity-Based Scheduling)
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka –∏ PostgreSQL

**–ü–æ—á–µ–º—É gRPC?**
- –ë–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª (–±—ã—Å—Ç—Ä–µ–µ JSON)
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Protobuf)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ streaming
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

### 2. PostgreSQL

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:
- ‚úÖ **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å SERIALIZABLE –∏–∑–æ–ª—è—Ü–∏–µ–π (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions)
- ‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤)
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (BootstrapState)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
- –¢–∞–±–ª–∏—Ü–∞ `orders` (–ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ `created_at`)
- JSONB –ø–æ–ª–µ `items` –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `(status, created_at)` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –ø–æ—Å–ª–µ Kafka)
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (—Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã

---

### 3. Kafka

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:
- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ (at-least-once delivery)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (Consumer Groups)
- ‚úÖ –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

**–¢–æ–ø–∏–∫**: `pizza-orders`
- **–§–æ—Ä–º–∞—Ç**: Protobuf (–±–∏–Ω–∞—Ä–Ω—ã–π)
- **Retention**: 24 —á–∞—Å–∞
- **Max Size**: 5GB

**–ü–æ—á–µ–º—É Kafka?**
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: –Ω–µ—Å–∫–æ–ª—å–∫–æ consumer'–æ–≤ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å: –∑–∞–∫–∞–∑—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ —Å–±–æ—è—Ö
- –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è: —Å–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –ø–∏–∫–æ–≤—ã–º–∏ –Ω–∞–≥—Ä—É–∑–∫–∞–º–∏

---

### 4. Kafka Consumer (`KafkaWSConsumer`)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:
- ‚úÖ –ß—Ç–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Kafka
- ‚úÖ –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è Protobuf
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –∏ PostgreSQL
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞ (pending_slots ‚Üí active)
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ WebSocket Hub

**Consumer Group**: `order-service-stable-group`
- –°—Ç–∞–±–∏–ª—å–Ω—ã–π group.id –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è offset
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- StartOffset: LastOffset (–ø–æ—Å–ª–µ bootstrap –∏–∑ –ë–î)

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
1. –ß–∏—Ç–∞–µ—Ç –∏–∑ Kafka
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ PostgreSQL (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
4. –î–æ–±–∞–≤–ª—è–µ—Ç –≤ `pending_slots` –∏–ª–∏ `active` (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `visibleAt`)
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ WebSocket Hub

---

### 5. Redis

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:
- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ **–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** (pending_slots, active)
- ‚úÖ **Capacity-Based Slot Scheduling** (–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Lua scripts)
- ‚úÖ **Pub/Sub** –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**:
- `erp:order:{id}` - –∑–∞–∫–∞–∑ –≤ JSON/Protobuf (TTL: 24 —á–∞—Å–∞)
- `erp:orders:pending_slots` - Set –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
- `erp:orders:active` - Set –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- `order:slot:start:{id}` - –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–ª–æ—Ç–∞
- `order:visible_at:{id}` - –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –∑–∞–∫–∞–∑–∞
- `slot:{slot_id}` - –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ—Ç–∞ (capacity)
- `slot:config:max_capacity` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –µ–º–∫–æ—Å—Ç—å —Å–ª–æ—Ç–∞

**–ü–æ—á–µ–º—É Redis?**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (< 1ms)
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (Lua scripts)
- Pub/Sub –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- TTL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏

---

### 6. WebSocket Hub (`GlobalHub`)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ KDS-—ç–∫—Ä–∞–Ω–æ–≤
- ‚úÖ Broadcast –∑–∞–∫–∞–∑–æ–≤ –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
- ‚úÖ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (mutex –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ clients)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:
```go
type Hub struct {
    clients   map[*websocket.Conn]bool
    broadcast chan []byte  // –ë—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª (256)
    mutex     sync.RWMutex
}
```

**–î–≤–∞ Hub'–∞**:
- `GlobalHub` - –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –ø–æ–≤–∞—Ä–æ–≤ (KDS)
- `ERPHub` - –¥–ª—è ERP Dashboard

**–ü–æ—á–µ–º—É WebSocket?**
- Real-time –¥–æ—Å—Ç–∞–≤–∫–∞ (–±–µ–∑ polling)
- –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–≤—è–∑—å (–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –æ—Ç –ø–æ–≤–∞—Ä–∞)
- –ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

---

## üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤

**–ö–ª—é—á**: `erp:order:{id}`

**–ó–Ω–∞—á–µ–Ω–∏–µ**: –ó–∞–∫–∞–∑ –≤ JSON –∏–ª–∏ Protobuf —Ñ–æ—Ä–º–∞—Ç–µ

**TTL**: 24 —á–∞—Å–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫–∞–∑—É –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ PostgreSQL
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ KDS-—ç–∫—Ä–∞–Ω–∞—Ö

---

### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–∫–∞–∑–æ–≤

**Sets**:
- `erp:orders:pending_slots` - –∑–∞–∫–∞–∑—ã, –æ–∂–∏–¥–∞—é—â–∏–µ –ø–æ–∫–∞–∑–∞ (visibleAt –≤ –±—É–¥—É—â–µ–º)
- `erp:orders:active` - –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã –Ω–∞ KDS-—ç–∫—Ä–∞–Ω–∞—Ö

**–õ–æ–≥–∏–∫–∞**:
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `pending_slots` (–µ—Å–ª–∏ `visibleAt` –≤ –±—É–¥—É—â–µ–º)
2. –ü—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ `visibleAt` ‚Üí –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –≤ `active`
3. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí –æ—Å—Ç–∞–µ—Ç—Å—è –≤ `active` –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–ü–æ—á–µ–º—É Sets?**
- –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏: `SISMEMBER`
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: `SADD`, `SREM`
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤

---

### 3. Capacity-Based Slot Scheduling

**–ö–ª—é—á–∏**:
- `slot:{slot_id}` - —Ç–µ–∫—É—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ—Ç–∞ (—Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö)
- `slot:{slot_id}:info` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–æ—Ç–µ (start_time, end_time, max_capacity)
- `slot:{slot_id}:orders` - Set –∑–∞–∫–∞–∑–æ–≤ –≤ —Å–ª–æ—Ç–µ
- `order:slot:{id}` - —Å–≤—è–∑—å –∑–∞–∫–∞–∑ ‚Üí —Å–ª–æ—Ç (slot_id, price)

**Lua Script** (–∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è):
```lua
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ capacity
local current_load = redis.call('GET', slot_key)
if current_load + order_price > max_capacity then
    return {0, current_load} -- –°–ª–æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω
end

-- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
redis.call('INCRBY', slot_key, order_price)
redis.call('EXPIRE', slot_key, 7200) -- TTL 2 —á–∞—Å–∞

-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∏ –∑–∞–∫–∞–∑ ‚Üí —Å–ª–æ—Ç
redis.call('HSET', order_key, 'slot_id', slot_id, 'price', order_price)
```

**–ü–æ—á–µ–º—É Lua Script?**
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å: –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –æ–¥–∏–Ω —Å–µ—Ç–µ–≤–æ–π –≤—ã–∑–æ–≤ –≤–º–µ—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö

---

### 4. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤

**–ö–ª—é—á–∏**:
- `order:slot:start:{id}` - –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–ª–æ—Ç–∞ (RFC3339)
- `order:visible_at:{id}` - –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –∑–∞–∫–∞–∑–∞ (RFC3339)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –∏–∑ `pending_slots` –≤ `active`
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ KDS-—ç–∫—Ä–∞–Ω–µ

---

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 1. ResourceExhausted - "All slots are full"

**–ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç**:
- –í—Å–µ —Å–ª–æ—Ç—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ 100% (capacity –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞)
- –ö—É—Ö–Ω—è –∑–∞–∫—Ä—ã—Ç–∞ (–≤–Ω–µ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤)

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ `SlotService.AssignSlot()`**:
```go
// –ü—Ä–æ–≤–µ—Ä–∫–∞ capacity —á–µ—Ä–µ–∑ Lua script
if current_load + order_price > max_capacity {
    // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–ª–æ—Ç
    slotStart = slotStart.Add(slotDuration)
    continue
}

// –ï—Å–ª–∏ –≤—Å–µ —Å–ª–æ—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
if slotsChecked > 0 && isKitchenOpen {
    return status.Error(codes.ResourceExhausted, "All slots are full for today")
}
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ gRPC Server**:
```go
slotID, slotStartTime, visibleAt, err := slotService.AssignSlot(...)
if err != nil {
    log.Printf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–ª–æ—Ç: %v", err)
    return nil, err // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É –∫–ª–∏–µ–Ω—Ç—É
}
```

**–û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É**:
```protobuf
rpc error: code = ResourceExhausted 
desc = All slots are full for today
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –ó–∞–∫–∞–∑ **–ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è**
- –ó–∞–∫–∞–∑ **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –≤ Redis/PostgreSQL
- –ó–∞–∫–∞–∑ **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** –≤ Kafka
- –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É –∏ –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ

---

### 2. –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ PostgreSQL

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
```go
go func() {
    if err := orderService.SaveOrderWithTransaction(order); err != nil {
        log.Printf("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ %s –≤ PostgreSQL: %v", orderID, err)
        // –ó–∞–∫–∞–∑ —É–∂–µ –≤ Redis –∏ Kafka, –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ
    }
}()
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –ó–∞–∫–∞–∑ **—É–∂–µ –≤ Redis** (–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø)
- –ó–∞–∫–∞–∑ **—É–∂–µ –≤ Kafka** (–º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)
- –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å
- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —á—Ç–µ–Ω–∏–∏ –∏–∑ Kafka –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ PostgreSQL

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**:
- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —á—Ç–µ–Ω–∏–∏ –∏–∑ Kafka –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ
- `ON CONFLICT DO UPDATE` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∑–∞–∫–∞–∑ –Ω–µ –±—É–¥–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω

---

### 3. –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Kafka

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
```go
go func() {
    err := kafkaWriter.WriteMessages(ctx, kafka.Message{...})
    if err != nil {
        log.Printf("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ %s –≤ Kafka: %v", orderID, err)
        // –ó–∞–∫–∞–∑ —É–∂–µ –≤ Redis, –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ
    }
}()
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –ó–∞–∫–∞–∑ **—É–∂–µ –≤ Redis** (–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø)
- –ó–∞–∫–∞–∑ **–ù–ï –≤ Kafka** (–Ω–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω Consumer'–æ–º)
- –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**:
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å dead letter queue
- –ú–æ–∂–Ω–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å Redis –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã

---

### 4. –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–∑ Kafka

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ Consumer**:
```go
msg, err := reader.ReadMessage(ctx)
if err != nil {
    if err == context.Canceled {
        return
    }
    log.Printf("‚ö†Ô∏è Kafka WS Consumer –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: %v", err)
    time.Sleep(1 * time.Second)
    continue // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- Consumer –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
- –ó–∞–∫–∞–∑ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ Kafka (–Ω–µ –ø–æ—Ç–µ—Ä—è–Ω)
- –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω —Å–Ω–æ–≤–∞

---

### 5. –û—à–∏–±–∫–∞ WebSocket Broadcast

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ Hub**:
```go
func (h *Hub) Run() {
    for {
        msg := <-h.broadcast
        for client := range h.clients {
            err := client.WriteMessage(websocket.TextMessage, msg)
            if err != nil {
                // –£–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø–∏—Å–∏
                h.RemoveClient(client)
            }
        }
    }
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
- –ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Hub'–∞
- –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ REST API

---

## üíø –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (PostgreSQL)

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è**:
- ‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã (—Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Å–ª–æ—Ç—ã, –≤—Ä–µ–º–µ–Ω–∞, –∫–ª–∏–µ–Ω—Ç—ã)

**–°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è**:
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã: –±–µ—Å—Å—Ä–æ—á–Ω–æ
- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã: 1 –≥–æ–¥ (–∑–∞—Ç–µ–º –∞—Ä—Ö–∏–≤–∏—Ä—É—é—Ç—Å—è)
- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã: –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ —Ö–æ–ª–æ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

**–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**:
- –¢–∞–±–ª–∏—Ü–∞ `orders` –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ `created_at` (–ø–æ –º–µ—Å—è—Ü–∞–º)
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- –£–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Redis)

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è**:
- ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã (TTL: 24 —á–∞—Å–∞)
- ‚úÖ –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (pending_slots, active)
- ‚úÖ Capacity —Å–ª–æ—Ç–æ–≤ (TTL: 2 —á–∞—Å–∞)
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤ (TTL: 24 —á–∞—Å–∞)

**–°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è**:
- –ó–∞–∫–∞–∑—ã: 24 —á–∞—Å–∞ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã)
- –°–ª–æ—Ç—ã: 2 —á–∞—Å–∞ (–∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞)
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: 24 —á–∞—Å–∞

**–ü–æ—á–µ–º—É –≤—Ä–µ–º–µ–Ω–Ω–æ–µ?**
- Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –Ω–µ –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- TTL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
- –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏
- PostgreSQL - –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è

---

### –ë—É—Ñ–µ—Ä (Kafka)

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è**:
- ‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ Kafka
- ‚úÖ –§–æ—Ä–º–∞—Ç: Protobuf (–±–∏–Ω–∞—Ä–Ω—ã–π)

**–°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è**:
- Retention: 24 —á–∞—Å–∞
- Max Size: 5GB

**–ü–æ—á–µ–º—É –≤—Ä–µ–º–µ–Ω–Ω–æ–µ?**
- Kafka - –±—É—Ñ–µ—Ä –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Consumer'–æ–º –∑–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ PostgreSQL
- Retention –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑—ã –ø—Ä–∏ —Å–±–æ—è—Ö

---

## üìä –î–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Ç–æ–∫–æ–≤

### –ü–æ–ª–Ω—ã–π Data Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ö–ª–∏–µ–Ω—Ç    ‚îÇ
‚îÇ (Mobile App)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1. gRPC: CreateOrder()
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Go gRPC API                   ‚îÇ
‚îÇ   (OrderGRPCServer)             ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚Ä¢ –í–∞–ª–∏–¥–∞—Ü–∏—è                    ‚îÇ
‚îÇ  ‚Ä¢ –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã                  ‚îÇ
‚îÇ  ‚Ä¢ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–æ—Ç–∞             ‚îÇ
‚îÇ  ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ Protobuf            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ 2. Redis Pipeline (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
       ‚îÇ   ‚Ä¢ SET erp:order:{id}
       ‚îÇ   ‚Ä¢ SADD erp:orders:pending_slots
       ‚îÇ   ‚Ä¢ INCR counters
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ 3. Kafka Producer (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
       ‚îÇ   ‚Ä¢ Topic: pizza-orders
       ‚îÇ   ‚Ä¢ Format: Protobuf
       ‚îÇ
       ‚îî‚îÄ‚ñ∫ 4. PostgreSQL (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
           ‚Ä¢ INSERT INTO orders
           ‚Ä¢ SERIALIZABLE transaction
           ‚Ä¢ Retry logic
       ‚îÇ
       ‚îÇ 5. Response –∫–ª–∏–µ–Ω—Ç—É
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ö–ª–∏–µ–Ω—Ç    ‚îÇ
‚îÇ (–ø–æ–ª—É—á–∏–ª ID)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Kafka Topic: pizza-orders       ‚îÇ
‚îÇ   (–ë—É—Ñ–µ—Ä –∑–∞–∫–∞–∑–æ–≤)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 6. Consumer —á–∏—Ç–∞–µ—Ç
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Kafka Consumer                ‚îÇ
‚îÇ   (KafkaWSConsumer)             ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚Ä¢ –ß—Ç–µ–Ω–∏–µ –∏–∑ Kafka              ‚îÇ
‚îÇ  ‚Ä¢ –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è Protobuf      ‚îÇ
‚îÇ  ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis           ‚îÇ
‚îÇ  ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL      ‚îÇ
‚îÇ  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ pending_slots     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ 7. Redis
       ‚îÇ   ‚Ä¢ SET erp:order:{id}
       ‚îÇ   ‚Ä¢ SADD erp:orders:pending_slots
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ 8. PostgreSQL
       ‚îÇ   ‚Ä¢ INSERT/UPDATE orders
       ‚îÇ
       ‚îî‚îÄ‚ñ∫ 9. WebSocket Hub
           ‚Ä¢ BroadcastMessage()
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   WebSocket Hub (GlobalHub)     ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏      ‚îÇ
‚îÇ  ‚Ä¢ Broadcast –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 10. WebSocket —Å–æ–æ–±—â–µ–Ω–∏–µ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  KDS-—ç–∫—Ä–∞–Ω  ‚îÇ
‚îÇ  (–ü–æ–≤–∞—Ä)    ‚îÇ
‚îÇ             ‚îÇ
‚îÇ  ‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞            ‚îÇ
‚îÇ  ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Capacity-Based Slot Scheduling

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   SlotService.AssignSlot()      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ 2. –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–ª–æ—Ç–∞
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ 3. Redis Lua Script (–∞—Ç–æ–º–∞—Ä–Ω–æ)
       ‚îÇ   ‚Ä¢ GET slot:{id} (—Ç–µ–∫—É—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
       ‚îÇ   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞: current_load + order_price <= max_capacity
       ‚îÇ   ‚Ä¢ INCRBY slot:{id} order_price
       ‚îÇ   ‚Ä¢ HSET order:slot:{id} slot_id, price
       ‚îÇ   ‚Ä¢ SADD slot:{id}:orders order_id
       ‚îÇ
       ‚îî‚îÄ‚ñ∫ 4. –í–æ–∑–≤—Ä–∞—Ç: slotID, slotStartTime, visibleAt
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞

```
pending_slots (Redis Set)
    ‚îÇ
    ‚îÇ visibleAt <= now
    ‚ñº
active (Redis Set)
    ‚îÇ
    ‚îÇ status: preparing ‚Üí cooking ‚Üí ready
    ‚ñº
completed (PostgreSQL)
    ‚îÇ
    ‚îÇ created_at < 1 year ago
    ‚ñº
archived (PostgreSQL)
```

---

## üîç –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (800+ RPS)
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–ß—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**:
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL
- WebSocket broadcast

**–ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**:
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis (–±—ã—Å—Ç—Ä–æ, < 1ms)
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–æ—Ç–∞ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

---

### 2. Event-Driven Architecture

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–Ω–µ—Å–∫–æ–ª—å–∫–æ consumer'–æ–≤)
- –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (–∑–∞–∫–∞–∑—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è)
- –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

**–ü–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–π**:
1. –°–æ–±—ã—Ç–∏–µ: "–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω" ‚Üí Kafka
2. –°–æ–±—ã—Ç–∏–µ: "–ó–∞–∫–∞–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω" ‚Üí Consumer
3. –°–æ–±—ã—Ç–∏–µ: "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –ø–æ–∫–∞–∑—É" ‚Üí WebSocket

---

### 3. –î–≤–æ–π–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

**–ü–æ—á–µ–º—É –¥–≤–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞?**
- **Redis**: –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø, –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **PostgreSQL**: –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**:
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: BootstrapState –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ PostgreSQL –≤ Redis
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏: –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –æ–±–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞—Ö

---

### 4. Capacity-Based Slot Scheduling

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –∫—É—Ö–Ω–∏
- –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
- –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (maxCapacity, duration)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- Redis Lua Script –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ capacity –ø–µ—Ä–µ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ª–æ—Ç–∞

---

## üìù –†–µ–∑—é–º–µ

**–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∑–∞–∫–∞–∑–∞**:

1. **–ö–ª–∏–µ–Ω—Ç** ‚Üí gRPC API (–≤–∞–ª–∏–¥–∞—Ü–∏—è, —Ä–∞—Å—á–µ—Ç, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–æ—Ç–∞)
2. **gRPC API** ‚Üí Redis (–±—ã—Å—Ç—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
3. **gRPC API** ‚Üí Kafka (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞)
4. **gRPC API** ‚Üí PostgreSQL (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
5. **Kafka** ‚Üí Consumer (—á—Ç–µ–Ω–∏–µ, –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è)
6. **Consumer** ‚Üí Redis (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
7. **Consumer** ‚Üí PostgreSQL (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
8. **Consumer** ‚Üí WebSocket Hub (broadcast)
9. **WebSocket Hub** ‚Üí KDS-—ç–∫—Ä–∞–Ω (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**:
- –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç: **< 50ms** (Redis + –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–æ—Ç–∞)
- –ó–∞–∫–∞–∑ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ KDS: **< 200ms** (Kafka + Consumer + WebSocket)

**–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**:
- –ó–∞–∫–∞–∑ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è (Kafka retention 24 —á–∞—Å–∞)
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è (BootstrapState –∏–∑ PostgreSQL)
- Race conditions –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã (SERIALIZABLE —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, Redis Lua scripts)

