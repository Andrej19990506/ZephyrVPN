<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–†–ü–ò - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .current-time {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .role-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-selector label {
            font-weight: bold;
            color: #1e3c72;
        }

        .role-selector select {
            padding: 8px 12px;
            border: 2px solid #1e3c72;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            color: #1e3c72;
            cursor: pointer;
        }

        .role-selector select:hover {
            background: #f0f4ff;
        }

        .kitchen-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .courier-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .admin-info {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .role-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-selector label {
            font-weight: bold;
            color: #1e3c72;
        }

        .role-selector select {
            padding: 8px 12px;
            border: 2px solid #1e3c72;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            color: #1e3c72;
            cursor: pointer;
        }

        .role-selector select:hover {
            background: #f0f4ff;
        }

        .pagination-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 5px;
        }

        .orders-container {
            position: relative;
            height: calc(100vh - 200px);
            overflow: hidden;
            padding-top: 5px;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            align-content: start;
            padding-top: 5px;
            height: 100%;
            overflow: hidden;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 3px 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pagination-btn {
            padding: 8px 12px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #2d5aa0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination-info {
            font-weight: bold;
            color: #1e3c72;
            font-size: 0.9rem;
            padding: 0 5px;
        }

        .order-block {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .order-block:hover {
            border-color: #1e3c72;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.2);
        }

        .order-block.processed {
            opacity: 0.6;
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .order-block.processed::after {
            content: '‚úÖ –û–ë–†–ê–ë–û–¢–ê–ù';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #4caf50;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .order-block.pending-click {
            border-color: #ff9800 !important;
            background: #fff3e0 !important;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.3) !important;
            animation: pulse 0.5s ease-in-out infinite alternate;
        }

        .order-block.pending-click::before {
            content: 'üëÜ –ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff9800;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
            animation: countdown 2s linear;
        }

        @keyframes pulse {
            from {
                box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.3);
            }
            to {
                box-shadow: 0 0 0 6px rgba(255, 152, 0, 0.1);
            }
        }

        @keyframes countdown {
            from {
                opacity: 1;
            }
            to {
                opacity: 0.5;
            }
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            flex-shrink: 0;
        }

        .order-id {
            font-weight: bold;
            color: #1e3c72;
            font-size: 1.2rem;
        }

        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status-pending {
            background: #ffc107;
            color: #333;
        }

        .status-preparing {
            background: #2196f3;
            color: white;
        }

        .status-ready {
            background: #4caf50;
            color: white;
        }

        .status-delivered {
            background: #9e9e9e;
            color: white;
        }

        .order-time {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .order-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
        }

        .order-content::-webkit-scrollbar {
            width: 6px;
        }

        .order-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .order-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .order-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .set-block {
            background: #f0f4ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #1e3c72;
            border: 2px solid #1e3c72;
        }

        .separator {
            height: 2px;
            background: linear-gradient(90deg, transparent, #1e3c72, transparent);
            margin: 15px 0;
            border-radius: 2px;
        }

        .separator-label {
            text-align: center;
            color: #1e3c72;
            font-weight: bold;
            font-size: 0.9rem;
            margin: 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .set-title {
            font-weight: bold;
            color: #1e3c72;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .pizza-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .pizza-item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .pizza-item-ingredients {
            font-size: 0.85rem;
            color: #666;
            margin: 5px 0;
        }

        .info-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 8px;
            cursor: pointer;
            color: #1e3c72;
            font-size: 0.9rem;
            vertical-align: middle;
            transition: all 0.2s;
        }

        .info-icon:hover {
            color: #ff6b6b;
            transform: scale(1.2);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 0;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .close-modal {
            font-size: 2rem;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: #ff6b6b;
        }

        .ingredient-list {
            list-style: none;
            padding: 0;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #1e3c72;
        }

        .ingredient-name {
            font-weight: 600;
            color: #333;
        }

        .ingredient-amount {
            color: #1e3c72;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .pizza-item-extras {
            font-size: 0.85rem;
            color: #4caf50;
            margin-top: 5px;
        }

        .pizza-item-quantity {
            display: inline-block;
            background: #1e3c72;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
            margin-top: 15px;
        }

        .total-label {
            font-weight: bold;
            color: #333;
        }

        .total-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            background: white;
            border-radius: 12px;
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .hint {
            font-size: 0.85rem;
            color: #999;
            margin-top: 10px;
            font-style: italic;
        }

        .kitchen-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .courier-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .admin-info {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="current-time" id="currentTime">--:--:--</div>
            <div class="role-selector">
                <label for="roleSelect">–†–æ–ª—å:</label>
                <select id="roleSelect" onchange="changeRole(this.value)">
                    <option value="kitchen">–ö—É—Ö–Ω—è</option>
                    <option value="courier">–ö—É—Ä—å–µ—Ä</option>
                    <option value="admin">–ê–¥–º–∏–Ω</option>
                </select>
            </div>
        </div>

        <div class="pagination-wrapper">
                <div class="pagination-controls" id="paginationControls" style="display: none;">
                    <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)" title="–ù–∞–∑–∞–¥">‚Üê</button>
                    <span class="pagination-info" id="pageInfo">1/1</span>
                    <button class="pagination-btn" id="nextBtn" onclick="changePage(1)" title="–í–ø–µ—Ä–µ–¥">‚Üí</button>
                </div>
        </div>

        <div class="orders-container">
            <div class="orders-grid" id="ordersList"></div>
        </div>
    </div>

    <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ –¥–ª—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ -->
    <div id="ingredientsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">üìã –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</div>
                <span class="close-modal" onclick="closeModal('ingredientsModal')">&times;</span>
            </div>
            <ul class="ingredient-list" id="modalIngredientList"></ul>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∏–ª–∏ localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let currentRole = urlParams.get('role') || localStorage.getItem('erp_role') || 'kitchen';
        localStorage.setItem('erp_role', currentRole);
        
        let orders = [];
        let processedCount = 0;
        let totalCount = 0;
        let hasMore = false;
        let currentPage = 0;
        const ordersPerPage = 3;
        
        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        let ws = null;
        let wsReconnectTimer = null;
        const WS_RECONNECT_DELAY = 3000; // 3 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
        
        // AudioContext –¥–ª—è –∑–≤—É–∫–∞ (—Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è)
        let audioContext = null;
        let audioContextInitialized = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioContext –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function initAudioContext() {
            if (!audioContextInitialized) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioContextInitialized = true;
                    console.log('‚úÖ AudioContext –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } catch (error) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å AudioContext:', error);
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º AudioContext –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.addEventListener('click', initAudioContext, { once: true });
        document.addEventListener('touchstart', initAudioContext, { once: true });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function playNotificationSound() {
            // –ï—Å–ª–∏ AudioContext –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            if (!audioContextInitialized) {
                initAudioContext();
            }
            
            // –ï—Å–ª–∏ AudioContext –≤—Å–µ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–≤—É–∫
            if (!audioContext) {
                console.warn('AudioContext –Ω–µ –≥–æ—Ç–æ–≤, –∑–≤—É–∫ –ø—Ä–æ–ø—É—â–µ–Ω');
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ AudioContext (–º–æ–∂–µ—Ç –±—ã—Ç—å suspended)
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        playSound();
                    }).catch(err => {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å AudioContext:', err);
                    });
                } else {
                    playSound();
                }
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', error);
            }
            
            function playSound() {
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    // –ü–æ–¥–∫–ª—é—á–∞–µ–º —É–∑–ª—ã
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–≤—É–∫ (–ø—Ä–∏—è—Ç–Ω—ã–π —Ç–æ–Ω)
                    oscillator.frequency.value = 800; // –ß–∞—Å—Ç–æ—Ç–∞ –≤ –ì—Ü
                    oscillator.type = 'sine'; // –°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω—ã–π —Ç–æ–Ω
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å (–ø–ª–∞–≤–Ω–æ–µ –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏–µ –∏ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ)
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error);
                }
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL WebSocket –Ω–∞ –æ—Å–Ω–æ–≤–µ API_BASE
            const apiUrl = new URL(API_BASE);
            const wsProtocol = apiUrl.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${apiUrl.host}/api/v1/erp/ws`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –¥–ª—è ERP');
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    loadBatch();
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
                };
                
                ws.onclose = () => {
                    console.log('‚ö†Ô∏è WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
                    ws = null;
                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    if (wsReconnectTimer) {
                        clearTimeout(wsReconnectTimer);
                    }
                    wsReconnectTimer = setTimeout(connectWebSocket, WS_RECONNECT_DELAY);
                };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:', error);
                // Fallback –Ω–∞ polling –µ—Å–ª–∏ WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                startPolling();
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç WebSocket
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'order_processed':
                    // –ó–∞–∫–∞–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    console.log('üì¶ –ó–∞–∫–∞–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ WebSocket:', message.data);
                    loadBatch();
                    break;
                case 'new_order':
                    // –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    console.log('üÜï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ WebSocket:', message.data);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç—ã–º –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                    const wasEmpty = orders.length === 0;
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                    loadBatch().then(() => {
                        console.log('üìã –ó–∞–∫–∞–∑–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', orders.length);
                        // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –±—ã–ª –ø—É—Å—Ç—ã–º, –∞ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∑–∞–∫–∞–∑—ã - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                        if (wasEmpty && orders.length > 0) {
                            console.log('üîî –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                            playNotificationSound();
                        }
                    }).catch(err => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤:', err);
                    });
                    break;
                case 'order_updated':
                    // –ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    console.log('üîÑ –ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ WebSocket:', message.data);
                    loadBatch();
                    break;
                default:
                    console.log('üì® WebSocket —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
            }
        }
        
        // Polling –∫–∞–∫ fallback (–µ—Å–ª–∏ WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
        let pollingInterval = null;
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            // Polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            pollingInterval = setInterval(() => {
                loadBatch();
            }, 5000);
            console.log('üîÑ Polling –∑–∞–ø—É—â–µ–Ω (fallback —Ä–µ–∂–∏–º)');
        }
        
        // –°–º–µ–Ω–∞ —Ä–æ–ª–∏
        function changeRole(newRole) {
            currentRole = newRole;
            localStorage.setItem('erp_role', newRole);
            loadBatch(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã —Å –Ω–æ–≤–æ–π —Ä–æ–ª—å—é
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
        function getRoleSpecificInfo(order, orderItems) {
            let info = '';
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–≤–∞—Ä–æ–≤ (—á—Ç–æ –Ω–µ –∫–ª–∞—Å—Ç—å)
            if (currentRole === 'kitchen' || currentRole === 'admin') {
                const excludeItems = [];
                orderItems.forEach(item => {
                    if (item.exclude_ingredients && item.exclude_ingredients.length > 0) {
                        excludeItems.push(`${item.pizza_name || '–ü–∏—Ü—Ü–∞'}: –Ω–µ –∫–ª–∞—Å—Ç—å ${item.exclude_ingredients.join(', ')}`);
                    }
                });
                if (excludeItems.length > 0) {
                    info += `<div class="kitchen-info"><strong>‚ö†Ô∏è –ù–µ –∫–ª–∞—Å—Ç—å:</strong><br>${excludeItems.join('<br>')}</div>`;
                }
            }
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤
            if (currentRole === 'courier' || currentRole === 'admin') {
                if (order.delivery_address) {
                    info += `<div class="courier-info"><strong>üìç –ê–¥—Ä–µ—Å:</strong> ${order.delivery_address}</div>`;
                }
                if (order.customer_phone) {
                    info += `<div class="courier-info"><strong>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.customer_phone}</div>`;
                }
                if (order.call_before_minutes && order.call_before_minutes > 0) {
                    info += `<div class="courier-info"><strong>‚è∞ –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞:</strong> ${order.call_before_minutes} –º–∏–Ω—É—Ç –¥–æ –¥–æ—Å—Ç–∞–≤–∫–∏</div>`;
                }
                if (order.payment_method) {
                    const paymentText = {
                        'CASH': '–ù–∞–ª–∏—á–Ω—ã–µ',
                        'CARD_ONLINE': '–ö–∞—Ä—Ç–∞ –æ–Ω–ª–∞–π–Ω',
                        'CRYPTO': '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞'
                    };
                    info += `<div class="courier-info"><strong>üí≥ –û–ø–ª–∞—Ç–∞:</strong> ${paymentText[order.payment_method] || order.payment_method}</div>`;
                }
                if (order.is_pickup) {
                    info += `<div class="courier-info"><strong>üö∂ –°–∞–º–æ–≤—ã–≤–æ–∑</strong></div>`;
                }
            }
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ (—Å–∫–∏–¥–∫–∏, –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞)
            if (currentRole === 'admin') {
                if (order.discount_amount > 0 || order.discount_percent > 0) {
                    info += `<div class="admin-info"><strong>üí∞ –°–∫–∏–¥–∫–∞:</strong> `;
                    if (order.discount_percent > 0) {
                        info += `${order.discount_percent}%`;
                    }
                    if (order.discount_amount > 0) {
                        if (order.discount_percent > 0) info += ' –∏–ª–∏ ';
                        info += `${order.discount_amount} ‚ÇΩ`;
                    }
                    info += `</div>`;
                }
                if (order.final_price && order.final_price !== order.total_price) {
                    info += `<div class="admin-info"><strong>üíµ –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞:</strong> ${order.final_price} ‚ÇΩ</div>`;
                }
                if (order.notes) {
                    info += `<div class="admin-info"><strong>üìù –ó–∞–º–µ—Ç–∫–∏:</strong> ${order.notes}</div>`;
                }
            }
            
            return info;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function updateTime() {
            const timeElement = document.getElementById('currentTime');
            if (!timeElement) {
                return; // –≠–ª–µ–º–µ–Ω—Ç –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            }
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            timeElement.textContent = timeString;
        }

        async function loadBatch() {
            const ordersList = document.getElementById('ordersList');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã–ª –ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç—ã–º)
            const wasEmpty = orders.length === 0;
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ–ª—å –≤ –∑–∞–ø—Ä–æ—Å
                const response = await fetch(`${API_BASE}/erp/orders/batch?role=${currentRole}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º —á—Ç–æ –ø—Ä–∏—à–ª–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
                console.log('üì¶ –î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.orders && data.orders.length > 0) {
                    console.log('üìã –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑:', data.orders[0]);
                    console.log('üìã –ü–æ–ª—è –∑–∞–∫–∞–∑–∞:', Object.keys(data.orders[0]));
                    console.log('üìã Items –∑–∞–∫–∞–∑–∞:', data.orders[0].items);
                    if (data.orders[0].items && data.orders[0].items.length > 0) {
                        console.log('üìã –ü–µ—Ä–≤—ã–π item:', data.orders[0].items[0]);
                        console.log('üìã set_name –≤ item:', data.orders[0].items[0].set_name);
                        console.log('üìã is_set_item –≤ item:', data.orders[0].items[0].is_set_item);
                    }
                }
                
                const previousOrdersCount = orders.length;
                orders = data.orders || [];
                processedCount = data.processed || 0;
                totalCount = data.total || 0;
                hasMore = data.has_more || false;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                currentPage = 0;
                
                renderOrders();
                
                // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –±—ã–ª –ø—É—Å—Ç—ã–º, –∞ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∑–∞–∫–∞–∑—ã - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                if (wasEmpty && orders.length > 0) {
                    playNotificationSound();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.';
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'empty-state';
                errorDiv.innerHTML = `
                    <div class="empty-state-icon">‚ùå</div>
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</p>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: #f44336;">${errorMessage}</p>
                `;
                ordersList.innerHTML = '';
                ordersList.appendChild(errorDiv);
            }
        }


        async function markOrderProcessed(orderId) {
            try {
                const response = await fetch(`${API_BASE}/erp/orders/${orderId}/processed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞');
                }
                
                await loadBatch();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            const paginationControls = document.getElementById('paginationControls');
            
            if (orders.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `
                    <div class="empty-state-icon">üì¶</div>
                    <p>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">–ó–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ</p>
                `;
                ordersList.innerHTML = '';
                ordersList.appendChild(emptyDiv);
                paginationControls.style.display = 'none';
                return;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            const totalPages = Math.ceil(orders.length / ordersPerPage);
            const startIndex = currentPage * ordersPerPage;
            const endIndex = Math.min(startIndex + ordersPerPage, orders.length);
            const currentOrders = orders.slice(startIndex, endIndex);

            ordersList.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –±–ª–æ–∫–∏, –µ—Å–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –º–µ–Ω—å—à–µ 3
            for (let i = 0; i < ordersPerPage; i++) {
                if (i < currentOrders.length) {
                    const order = currentOrders[i];
                    renderOrderBlock(order, ordersList);
                } else {
                    // –ü—É—Å—Ç–æ–π –±–ª–æ–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏
                    const emptyBlock = document.createElement('div');
                    emptyBlock.className = 'order-block';
                    emptyBlock.style.visibility = 'hidden';
                    ordersList.appendChild(emptyBlock);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            updatePagination(totalPages);
        }

        function renderOrderBlock(order, ordersList) {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
                if (!order || !order.id) {
                    console.warn('–ü—Ä–æ–ø—É—â–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–∫–∞–∑:', order);
                    return;
                }
                
                // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–∫–∞–∑–∞
                console.log('üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑:', order.id);
                console.log('üîç –ü–æ–ª—è –∑–∞–∫–∞–∑–∞:', Object.keys(order));
                console.log('üîç order.items:', order.items);
                console.log('üîç order.Items:', order.Items);
                
                const orderBlock = document.createElement('div');
                orderBlock.className = 'order-block';
                
                // –î–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥ - –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≥–æ—Ç–æ–≤—ã–π
                let pendingClickTimer = null;
                let isPendingClick = false;
                
                orderBlock.onclick = (e) => {
                    e.stopPropagation();
                    
                    // –ï—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                    if (orderBlock.classList.contains('processed')) {
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –¥—Ä—É–≥–æ–π –∑–∞–∫–∞–∑ - –æ—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
                    if (window.pendingOrderClick.element && window.pendingOrderClick.element !== orderBlock) {
                        window.pendingOrderClick.element.classList.remove('pending-click');
                        if (window.pendingOrderClick.timer) {
                            clearTimeout(window.pendingOrderClick.timer);
                        }
                    }
                    
                    if (!orderBlock.classList.contains('pending-click')) {
                        // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç
                        orderBlock.classList.add('pending-click');
                        window.pendingOrderClick.element = orderBlock;
                        
                        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –±—ã–ª
                        if (window.pendingOrderClick.timer) {
                            clearTimeout(window.pendingOrderClick.timer);
                        }
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
                        window.pendingOrderClick.timer = setTimeout(() => {
                            // –í—Ä–µ–º—è –≤—ã—à–ª–æ - –æ—Ç–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä
                            if (window.pendingOrderClick.element) {
                                window.pendingOrderClick.element.classList.remove('pending-click');
                                window.pendingOrderClick.element = null;
                            }
                            window.pendingOrderClick.timer = null;
                        }, 2000);
                    } else {
                        // –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥ - –æ—Ç–º–µ—á–∞–µ–º –∑–∞–∫–∞–∑
                        if (window.pendingOrderClick.timer) {
                            clearTimeout(window.pendingOrderClick.timer);
                            window.pendingOrderClick.timer = null;
                        }
                        orderBlock.classList.remove('pending-click');
                        window.pendingOrderClick.element = null;
                        
                        if (order.id) {
                            markOrderProcessed(order.id);
                        }
                    }
                };
                
                const orderStatus = order.status || 'pending';
                const statusClass = `status-${orderStatus}`;
                const statusText = {
                    'pending': '–û–∂–∏–¥–∞–µ—Ç',
                    'preparing': '–ì–æ—Ç–æ–≤–∏—Ç—Å—è',
                    'ready': '–ì–æ—Ç–æ–≤',
                    'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'
                };

                // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã
                let timeString = '--:--';
                let dateString = '--';
                try {
                    if (order.created_at) {
                        const orderDate = new Date(order.created_at);
                        if (!isNaN(orderDate.getTime())) {
                            timeString = orderDate.toLocaleTimeString('ru-RU', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            dateString = orderDate.toLocaleDateString('ru-RU');
                        }
                    }
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –∑–∞–∫–∞–∑–∞:', order.created_at, e);
                }

                let contentHtml = '';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ items (–ø—Ä–æ–±—É–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: items –∏ Items)
                const orderItems = order.items || order.Items || [];
                
                // –û—Ç–ª–∞–¥–∫–∞
                if (orderItems.length === 0) {
                    console.warn('‚ö†Ô∏è –ó–∞–∫–∞–∑ –±–µ–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤!', {
                        orderId: order.id,
                        hasItems: !!order.items,
                        hasItemsCapital: !!order.Items,
                        orderKeys: Object.keys(order)
                    });
                }

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–∏—Ü—Ü—ã
                function renderPizzaItem(item, itemIndex) {
                    const pizzaName = item.pizza_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    const quantity = item.quantity || 1;
                    const extras = item.extras && item.extras.length > 0 
                        ? '<div class="pizza-item-extras"><strong>–î–æ–ø—ã:</strong> ' + item.extras.join(', ') + '</div>' 
                        : '';
                    const price = item.price || 0;
                    const ingredientAmounts = item.ingredient_amounts || {};
                    const ingredients = item.ingredients || [];
                    
                    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–∞–ª–∫–∏
                    const modalDataKey = 'modal-data-' + itemIndex + '-' + Date.now();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ
                    if (!window.modalData) window.modalData = {};
                    window.modalData[modalDataKey] = {
                        pizzaName: pizzaName,
                        ingredients: ingredients,
                        ingredientAmounts: ingredientAmounts
                    };
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—É —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –∫—É—Ä—å–µ—Ä–æ–≤, –Ω–µ –¥–ª—è –ø–æ–≤–∞—Ä–æ–≤
                    const priceHtml = (currentRole !== 'kitchen') 
                        ? '<div style="margin-top: 8px; font-weight: bold; color: #1e3c72;">–¶–µ–Ω–∞: ' + price + ' ‚ÇΩ</div>' 
                        : '';
                    
                    return '<div class="pizza-item">' +
                        '<div class="pizza-item-name">' + pizzaName +
                        '<span class="pizza-item-quantity">x' + quantity + '</span>' +
                        '<span class="info-icon" onclick="openIngredientsModal(\'' + modalDataKey + '\')" title="–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –¥–æ–∑–∏—Ä–æ–≤–∫–∞">‚ÑπÔ∏è</span>' +
                        '</div>' +
                        extras +
                        priceHtml +
                        '</div>';
                }

                // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç: –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –Ω–∞–±–æ—Ä–∞–º, –ø–æ—Ç–æ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∏—Ü—Ü—ã
                contentHtml = '';
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º items –ø–æ –Ω–∞–±–æ—Ä–∞–º (–µ—Å–ª–∏ —É item –µ—Å—Ç—å set_name)
                const setsMap = new Map(); // Map<setName, items[]>
                const individualItems = [];
                
                console.log('üîç –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ items. –í—Å–µ–≥–æ items:', orderItems.length);
                
                orderItems.forEach((item, idx) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è (snake_case –∏ camelCase)
                    const setName = item.set_name || item.setName;
                    const isSetItem = item.is_set_item !== undefined ? item.is_set_item : (item.isSetItem !== undefined ? item.isSetItem : false);
                    
                    console.log(`üîç Item ${idx}:`, {
                        pizza_name: item.pizza_name,
                        set_name: setName,
                        is_set_item: isSetItem,
                        allKeys: Object.keys(item)
                    });
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å set_name, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–±–æ—Ä–∞
                    if (setName) {
                        // –≠—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–±–æ—Ä–∞
                        if (!setsMap.has(setName)) {
                            setsMap.set(setName, []);
                        }
                        setsMap.get(setName).push(item);
                        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–∞–±–æ—Ä: ${setName}`);
                    } else {
                        // –≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–∏—Ü—Ü–∞
                        individualItems.push(item);
                        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–∏—Ü—Ü–∞`);
                    }
                });
                
                console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:', {
                    setsCount: setsMap.size,
                    individualCount: individualItems.length,
                    setsNames: Array.from(setsMap.keys())
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–±–æ—Ä—ã
                setsMap.forEach((setItems, setName) => {
                    let itemsHtml = '';
                    if (setItems.length > 0) {
                        itemsHtml = setItems.map((item, idx) => renderPizzaItem(item, 'set-' + setName + '-' + idx)).join('');
                    } else {
                        itemsHtml = '<div class="pizza-item">–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –Ω–∞–±–æ—Ä–µ</div>';
                    }
                    contentHtml += '<div class="set-block">' +
                        '<div class="set-title">üì¶ –ù–∞–±–æ—Ä: ' + (setName || '–ù–∞–±–æ—Ä') + '</div>' +
                        itemsHtml +
                        '</div>';
                });
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–±–æ—Ä—ã –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∏—Ü—Ü—ã - –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                if (setsMap.size > 0 && individualItems.length > 0) {
                    contentHtml += '<div class="separator"></div>';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∏—Ü—Ü—ã
                if (individualItems.length > 0) {
                    contentHtml += individualItems.map((item, idx) => renderPizzaItem(item, 'ind-' + idx)).join('');
                } else if (setsMap.size === 0 && orderItems.length === 0) {
                    contentHtml = '<div class="pizza-item">–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∑–∞–∫–∞–∑–µ</div>';
                }
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ DisplayID –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã
                const displayId = String(order.display_id || order.displayId || order.id || '0000');
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ display_id
                const digitsOnly = displayId.replace(/\D/g, '');
                // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã
                const orderIdShort = digitsOnly.length >= 4 
                    ? digitsOnly.slice(-4) 
                    : digitsOnly.padStart(4, '0');
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã
                const totalPrice = order.total_price || order.totalPrice || 0;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –∫—É—Ä—å–µ—Ä–æ–≤, –Ω–µ –¥–ª—è –ø–æ–≤–∞—Ä–æ–≤
                const totalPriceHtml = (currentRole !== 'kitchen') 
                    ? `<div class="order-total">
                        <span class="total-label">–ò—Ç–æ–≥–æ:</span>
                        <span class="total-price">${totalPrice} ‚ÇΩ</span>
                    </div>`
                    : '';
                
                orderBlock.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">–ó–∞–∫–∞–∑ #${orderIdShort}</span>
                        <span class="order-status ${statusClass}">${statusText[orderStatus] || orderStatus}</span>
                    </div>
                    <div class="order-time">${dateString} ${timeString}</div>
                    <div class="order-content">
                        ${contentHtml}
                    </div>
                    ${totalPriceHtml}
                    ${getRoleSpecificInfo(order, orderItems)}
                    <div class="hint">üí° –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –≥–æ—Ç–æ–≤—ã–π</div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ DOM
                try {
                    ordersList.appendChild(orderBlock);
                    console.log('‚úÖ –ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ DOM:', order.id);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ DOM:', error, order);
                }
        }

        function updatePagination(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            pageInfo.textContent = `${currentPage + 1}/${totalPages}`;
            
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage >= totalPages - 1;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(orders.length / ordersPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 0 && newPage < totalPages) {
                currentPage = newPage;
                renderOrders();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª–∫–æ–π
        function openIngredientsModal(modalDataKey) {
            if (!window.modalData || !window.modalData[modalDataKey]) {
                console.error('–î–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:', modalDataKey);
                return;
            }
            
            const data = window.modalData[modalDataKey];
            const modal = document.getElementById('ingredientsModal');
            const titleEl = document.getElementById('modalTitle');
            const listEl = document.getElementById('modalIngredientList');
            
            if (!modal || !titleEl || !listEl) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            titleEl.textContent = 'üìã ' + data.pizzaName + ' - –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã';
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
            listEl.innerHTML = '';
            data.ingredients.forEach(ing => {
                const amount = data.ingredientAmounts[ing] || 80;
                const li = document.createElement('li');
                li.className = 'ingredient-item';
                li.innerHTML = '<span class="ingredient-name">' + ing + '</span>' +
                    '<span class="ingredient-amount">' + amount + ' –≥</span>';
                listEl.appendChild(li);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            modal.style.display = 'block';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞
        window.pendingOrderClick = {
            element: null,
            timer: null
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∑–∞–∫–∞–∑–∞
        document.addEventListener('click', (e) => {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ –Ω–∞ order-block –∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä
            if (!e.target.closest('.order-block') && window.pendingOrderClick && window.pendingOrderClick.element) {
                window.pendingOrderClick.element.classList.remove('pending-click');
                if (window.pendingOrderClick.timer) {
                    clearTimeout(window.pendingOrderClick.timer);
                }
                window.pendingOrderClick.element = null;
                window.pendingOrderClick.timer = null;
            }
        }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è —Ä–∞–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞

        function init() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–æ–ª—å –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
            const roleSelect = document.getElementById('roleSelect');
            if (roleSelect) {
                roleSelect.value = currentRole;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
            updateTime(); // –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ —Å—Ä–∞–∑—É
            setInterval(updateTime, 1000); // –ó–∞—Ç–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            
            const ordersList = document.getElementById('ordersList');
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state';
            emptyDiv.innerHTML = `
                <div class="empty-state-icon">üì¶</div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
            `;
            ordersList.innerHTML = '';
            ordersList.appendChild(emptyDiv);
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            connectWebSocket();
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (wsReconnectTimer) {
                clearTimeout(wsReconnectTimer);
            }
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
