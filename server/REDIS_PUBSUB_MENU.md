# 🚀 Redis Pub/Sub для мгновенного обновления меню (Level: Senior)

## Архитектура

Вместо опроса БД каждые 5 минут, используется **Redis Pub/Sub** для мгновенного обновления меню на всех серверах одновременно.

### Как это работает:

```
┌─────────────┐
│  Админка    │ ← Изменяет меню в БД
└──────┬──────┘
       │
       │ POST /api/v1/admin/update-menu
       │
       ▼
┌─────────────────┐
│  API Server #1  │ ← Обновляет локально
└──────┬──────────┘
       │
       │ PUBLISH menu:update "now"
       │
       ▼
┌─────────────┐
│   Redis     │ ← Канал: menu:update
└──────┬──────┘
       │
       │ Broadcast всем подписчикам
       │
       ├──────────┬──────────┬──────────┐
       ▼          ▼          ▼          ▼
┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│ Server 1 │ │ Server 2 │ │ Server 3 │ │ Server N │
│ LoadMenu │ │ LoadMenu │ │ LoadMenu │ │ LoadMenu │
└──────────┘ └──────────┘ └──────────┘ └──────────┘
```

## Преимущества

✅ **Мгновенное обновление** - все серверы получают событие за миллисекунды  
✅ **Нет лишних запросов** - БД не опрашивается каждые 5 минут  
✅ **Масштабируемость** - работает с любым количеством серверов  
✅ **Fallback** - если Redis недоступен, работает таймер (5 минут)

## Использование

### 1. Обновить меню через API

```bash
POST /api/v1/admin/update-menu
```

**Что происходит:**
1. Локальный сервер обновляет меню из БД
2. Публикует событие в Redis: `PUBLISH menu:update "now"`
3. Все остальные серверы получают событие и обновляют меню

**Ответ:**
```json
{
  "message": "Menu updated successfully (broadcasted to all servers via Redis)",
  "last_update": "2026-01-31 22:00:00",
  "method": "redis_pubsub"
}
```

### 2. Изменить меню в БД напрямую

```sql
-- Добавить новую пиццу
INSERT INTO pizza_recipes (name, price, ingredients, ingredient_amounts) 
VALUES ('Маргарита', 449, '["сыр", "помидоры"]', '{"сыр": 150}');
```

Затем вызвать API для обновления:
```bash
curl -X POST http://localhost:8080/api/v1/admin/update-menu
```

### 3. Проверить статус

```bash
GET /api/v1/admin/menu-status
```

## Технические детали

### Redis канал
- **Название:** `menu:update`
- **Сообщение:** `"now"` (любое сообщение триггерит обновление)

### Fallback механизм
Если Redis недоступен:
- Pub/Sub не запускается
- Работает только таймер (обновление каждые 5 минут)
- Локальное обновление через API все равно работает

### Безопасность
- Используется `sync.RWMutex` для защиты от race conditions
- Мапы заменяются атомарно (целиком, а не по частям)
- Параллельное чтение не блокируется

## Пример логов

```
📡 Redis Pub/Sub для меню запущен (мгновенное обновление)
👂 Слушаем канал Redis: menu:update
🔄 Fallback автообновление меню запущено (каждые 5 минут)

# При обновлении через API:
🔔 Получено событие обновления меню из Redis: now
✅ Меню обновлено мгновенно через Redis Pub/Sub
✅ Меню обновлено из БД: 9 пицц, 3 наборов, 1 допов
```

## Масштабирование

При запуске нескольких API серверов:

```bash
# Server 1
docker run -d --name api1 -e DATABASE_URL=... -e REDIS_URL=...

# Server 2  
docker run -d --name api2 -e DATABASE_URL=... -e REDIS_URL=...

# Server 3
docker run -d --name api3 -e DATABASE_URL=... -e REDIS_URL=...
```

Все серверы автоматически подпишутся на канал `menu:update` и будут получать обновления одновременно!

---

**Готово! Теперь у тебя production-ready система обновления меню! 🎉**





